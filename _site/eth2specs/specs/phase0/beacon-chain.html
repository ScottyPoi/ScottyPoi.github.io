<h1> SSZ SimpleSerialize </h1>
<nav>
    <ul>
        
            <li><a href="/" title="SSZ Home Page">Home</a></li>
        
            <li><a href="/about" title="What is SSZ">About</a></li>
        
            <li><a href="/eth2specs/ssz/simple-serialize" title="SSZ Technical Specifications">Specs</a></li>
        
            <li><a href="/implementation" title="SSZ Implementation List">Implementation</a></li>
        
            <li><a href="/eth2specs/ssz/merkle-proofs" title="Merkle Proof Formats">Merkle Proofs</a></li>
        
            <li><a href="/demo" title="Playground">Demonstration</a></li>
        
    </ul>
</nav>
<p>  </p>

<h1 id="ethereum-20-phase-0--the-beacon-chain">Ethereum 2.0 Phase 0 – The Beacon Chain</h1>

<h2 id="table-of-contents">Table of contents</h2>
<!-- TOC -->
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

<ul>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#notation">Notation</a></li>
  <li><a href="#custom-types">Custom types</a></li>
  <li><a href="#constants">Constants</a></li>
  <li><a href="#configuration">Configuration</a>
    <ul>
      <li><a href="#misc">Misc</a></li>
      <li><a href="#gwei-values">Gwei values</a></li>
      <li><a href="#initial-values">Initial values</a></li>
      <li><a href="#time-parameters">Time parameters</a></li>
      <li><a href="#state-list-lengths">State list lengths</a></li>
      <li><a href="#rewards-and-penalties">Rewards and penalties</a></li>
      <li><a href="#max-operations-per-block">Max operations per block</a></li>
      <li><a href="#domain-types">Domain types</a></li>
    </ul>
  </li>
  <li><a href="#containers">Containers</a>
    <ul>
      <li><a href="#misc-dependencies">Misc dependencies</a>
        <ul>
          <li><a href="#fork"><code class="language-plaintext highlighter-rouge">Fork</code></a></li>
          <li><a href="#forkdata"><code class="language-plaintext highlighter-rouge">ForkData</code></a></li>
          <li><a href="#checkpoint"><code class="language-plaintext highlighter-rouge">Checkpoint</code></a></li>
          <li><a href="#validator"><code class="language-plaintext highlighter-rouge">Validator</code></a></li>
          <li><a href="#attestationdata"><code class="language-plaintext highlighter-rouge">AttestationData</code></a></li>
          <li><a href="#indexedattestation"><code class="language-plaintext highlighter-rouge">IndexedAttestation</code></a></li>
          <li><a href="#pendingattestation"><code class="language-plaintext highlighter-rouge">PendingAttestation</code></a></li>
          <li><a href="#eth1data"><code class="language-plaintext highlighter-rouge">Eth1Data</code></a></li>
          <li><a href="#historicalbatch"><code class="language-plaintext highlighter-rouge">HistoricalBatch</code></a></li>
          <li><a href="#depositmessage"><code class="language-plaintext highlighter-rouge">DepositMessage</code></a></li>
          <li><a href="#depositdata"><code class="language-plaintext highlighter-rouge">DepositData</code></a></li>
          <li><a href="#beaconblockheader"><code class="language-plaintext highlighter-rouge">BeaconBlockHeader</code></a></li>
          <li><a href="#signingdata"><code class="language-plaintext highlighter-rouge">SigningData</code></a></li>
        </ul>
      </li>
      <li><a href="#beacon-operations">Beacon operations</a>
        <ul>
          <li><a href="#proposerslashing"><code class="language-plaintext highlighter-rouge">ProposerSlashing</code></a></li>
          <li><a href="#attesterslashing"><code class="language-plaintext highlighter-rouge">AttesterSlashing</code></a></li>
          <li><a href="#attestation"><code class="language-plaintext highlighter-rouge">Attestation</code></a></li>
          <li><a href="#deposit"><code class="language-plaintext highlighter-rouge">Deposit</code></a></li>
          <li><a href="#voluntaryexit"><code class="language-plaintext highlighter-rouge">VoluntaryExit</code></a></li>
        </ul>
      </li>
      <li><a href="#beacon-blocks">Beacon blocks</a>
        <ul>
          <li><a href="#beaconblockbody"><code class="language-plaintext highlighter-rouge">BeaconBlockBody</code></a></li>
          <li><a href="#beaconblock"><code class="language-plaintext highlighter-rouge">BeaconBlock</code></a></li>
        </ul>
      </li>
      <li><a href="#beacon-state">Beacon state</a>
        <ul>
          <li><a href="#beaconstate"><code class="language-plaintext highlighter-rouge">BeaconState</code></a></li>
        </ul>
      </li>
      <li><a href="#signed-envelopes">Signed envelopes</a>
        <ul>
          <li><a href="#signedvoluntaryexit"><code class="language-plaintext highlighter-rouge">SignedVoluntaryExit</code></a></li>
          <li><a href="#signedbeaconblock"><code class="language-plaintext highlighter-rouge">SignedBeaconBlock</code></a></li>
          <li><a href="#signedbeaconblockheader"><code class="language-plaintext highlighter-rouge">SignedBeaconBlockHeader</code></a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#helper-functions">Helper functions</a>
    <ul>
      <li><a href="#math">Math</a>
        <ul>
          <li><a href="#integer_squareroot"><code class="language-plaintext highlighter-rouge">integer_squareroot</code></a></li>
          <li><a href="#xor"><code class="language-plaintext highlighter-rouge">xor</code></a></li>
          <li><a href="#uint_to_bytes"><code class="language-plaintext highlighter-rouge">uint_to_bytes</code></a></li>
          <li><a href="#bytes_to_uint64"><code class="language-plaintext highlighter-rouge">bytes_to_uint64</code></a></li>
        </ul>
      </li>
      <li><a href="#crypto">Crypto</a>
        <ul>
          <li><a href="#hash"><code class="language-plaintext highlighter-rouge">hash</code></a></li>
          <li><a href="#hash_tree_root"><code class="language-plaintext highlighter-rouge">hash_tree_root</code></a></li>
          <li><a href="#bls-signatures">BLS signatures</a></li>
        </ul>
      </li>
      <li><a href="#predicates">Predicates</a>
        <ul>
          <li><a href="#is_active_validator"><code class="language-plaintext highlighter-rouge">is_active_validator</code></a></li>
          <li><a href="#is_eligible_for_activation_queue"><code class="language-plaintext highlighter-rouge">is_eligible_for_activation_queue</code></a></li>
          <li><a href="#is_eligible_for_activation"><code class="language-plaintext highlighter-rouge">is_eligible_for_activation</code></a></li>
          <li><a href="#is_slashable_validator"><code class="language-plaintext highlighter-rouge">is_slashable_validator</code></a></li>
          <li><a href="#is_slashable_attestation_data"><code class="language-plaintext highlighter-rouge">is_slashable_attestation_data</code></a></li>
          <li><a href="#is_valid_indexed_attestation"><code class="language-plaintext highlighter-rouge">is_valid_indexed_attestation</code></a></li>
          <li><a href="#is_valid_merkle_branch"><code class="language-plaintext highlighter-rouge">is_valid_merkle_branch</code></a></li>
        </ul>
      </li>
      <li><a href="#misc-1">Misc</a>
        <ul>
          <li><a href="#compute_shuffled_index"><code class="language-plaintext highlighter-rouge">compute_shuffled_index</code></a></li>
          <li><a href="#compute_proposer_index"><code class="language-plaintext highlighter-rouge">compute_proposer_index</code></a></li>
          <li><a href="#compute_committee"><code class="language-plaintext highlighter-rouge">compute_committee</code></a></li>
          <li><a href="#compute_epoch_at_slot"><code class="language-plaintext highlighter-rouge">compute_epoch_at_slot</code></a></li>
          <li><a href="#compute_start_slot_at_epoch"><code class="language-plaintext highlighter-rouge">compute_start_slot_at_epoch</code></a></li>
          <li><a href="#compute_activation_exit_epoch"><code class="language-plaintext highlighter-rouge">compute_activation_exit_epoch</code></a></li>
          <li><a href="#compute_fork_data_root"><code class="language-plaintext highlighter-rouge">compute_fork_data_root</code></a></li>
          <li><a href="#compute_fork_digest"><code class="language-plaintext highlighter-rouge">compute_fork_digest</code></a></li>
          <li><a href="#compute_domain"><code class="language-plaintext highlighter-rouge">compute_domain</code></a></li>
          <li><a href="#compute_signing_root"><code class="language-plaintext highlighter-rouge">compute_signing_root</code></a></li>
        </ul>
      </li>
      <li><a href="#beacon-state-accessors">Beacon state accessors</a>
        <ul>
          <li><a href="#get_current_epoch"><code class="language-plaintext highlighter-rouge">get_current_epoch</code></a></li>
          <li><a href="#get_previous_epoch"><code class="language-plaintext highlighter-rouge">get_previous_epoch</code></a></li>
          <li><a href="#get_block_root"><code class="language-plaintext highlighter-rouge">get_block_root</code></a></li>
          <li><a href="#get_block_root_at_slot"><code class="language-plaintext highlighter-rouge">get_block_root_at_slot</code></a></li>
          <li><a href="#get_randao_mix"><code class="language-plaintext highlighter-rouge">get_randao_mix</code></a></li>
          <li><a href="#get_active_validator_indices"><code class="language-plaintext highlighter-rouge">get_active_validator_indices</code></a></li>
          <li><a href="#get_validator_churn_limit"><code class="language-plaintext highlighter-rouge">get_validator_churn_limit</code></a></li>
          <li><a href="#get_seed"><code class="language-plaintext highlighter-rouge">get_seed</code></a></li>
          <li><a href="#get_committee_count_per_slot"><code class="language-plaintext highlighter-rouge">get_committee_count_per_slot</code></a></li>
          <li><a href="#get_beacon_committee"><code class="language-plaintext highlighter-rouge">get_beacon_committee</code></a></li>
          <li><a href="#get_beacon_proposer_index"><code class="language-plaintext highlighter-rouge">get_beacon_proposer_index</code></a></li>
          <li><a href="#get_total_balance"><code class="language-plaintext highlighter-rouge">get_total_balance</code></a></li>
          <li><a href="#get_total_active_balance"><code class="language-plaintext highlighter-rouge">get_total_active_balance</code></a></li>
          <li><a href="#get_domain"><code class="language-plaintext highlighter-rouge">get_domain</code></a></li>
          <li><a href="#get_indexed_attestation"><code class="language-plaintext highlighter-rouge">get_indexed_attestation</code></a></li>
          <li><a href="#get_attesting_indices"><code class="language-plaintext highlighter-rouge">get_attesting_indices</code></a></li>
        </ul>
      </li>
      <li><a href="#beacon-state-mutators">Beacon state mutators</a>
        <ul>
          <li><a href="#increase_balance"><code class="language-plaintext highlighter-rouge">increase_balance</code></a></li>
          <li><a href="#decrease_balance"><code class="language-plaintext highlighter-rouge">decrease_balance</code></a></li>
          <li><a href="#initiate_validator_exit"><code class="language-plaintext highlighter-rouge">initiate_validator_exit</code></a></li>
          <li><a href="#slash_validator"><code class="language-plaintext highlighter-rouge">slash_validator</code></a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#genesis">Genesis</a>
    <ul>
      <li><a href="#genesis-state">Genesis state</a></li>
      <li><a href="#genesis-block">Genesis block</a></li>
    </ul>
  </li>
  <li><a href="#beacon-chain-state-transition-function">Beacon chain state transition function</a>
    <ul>
      <li><a href="#epoch-processing">Epoch processing</a>
        <ul>
          <li><a href="#helper-functions-1">Helper functions</a></li>
          <li><a href="#justification-and-finalization">Justification and finalization</a></li>
          <li><a href="#rewards-and-penalties-1">Rewards and penalties</a>
            <ul>
              <li><a href="#helpers">Helpers</a></li>
              <li><a href="#components-of-attestation-deltas">Components of attestation deltas</a></li>
              <li><a href="#get_attestation_deltas"><code class="language-plaintext highlighter-rouge">get_attestation_deltas</code></a></li>
              <li><a href="#process_rewards_and_penalties"><code class="language-plaintext highlighter-rouge">process_rewards_and_penalties</code></a></li>
            </ul>
          </li>
          <li><a href="#registry-updates">Registry updates</a></li>
          <li><a href="#slashings">Slashings</a></li>
          <li><a href="#final-updates">Final updates</a></li>
        </ul>
      </li>
      <li><a href="#block-processing">Block processing</a>
        <ul>
          <li><a href="#block-header">Block header</a></li>
          <li><a href="#randao">RANDAO</a></li>
          <li><a href="#eth1-data">Eth1 data</a></li>
          <li><a href="#operations">Operations</a>
            <ul>
              <li><a href="#proposer-slashings">Proposer slashings</a></li>
              <li><a href="#attester-slashings">Attester slashings</a></li>
              <li><a href="#attestations">Attestations</a></li>
              <li><a href="#deposits">Deposits</a></li>
              <li><a href="#voluntary-exits">Voluntary exits</a></li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<!-- /TOC -->

<h2 id="introduction">Introduction</h2>

<p>This document represents the specification for Phase 0 of Ethereum 2.0 – The Beacon Chain.</p>

<p>At the core of Ethereum 2.0 is a system chain called the “beacon chain”. The beacon chain stores and manages the registry of validators. In the initial deployment phases of Ethereum 2.0, the only mechanism to become a validator is to make a one-way ETH transaction to a deposit contract on Ethereum 1.0. Activation as a validator happens when Ethereum 1.0 deposit receipts are processed by the beacon chain, the activation balance is reached, and a queuing process is completed. Exit is either voluntary or done forcibly as a penalty for misbehavior.
The primary source of load on the beacon chain is “attestations”. Attestations are simultaneously availability votes for a shard block (Phase 1) and proof-of-stake votes for a beacon block (Phase 0).</p>

<h2 id="notation">Notation</h2>

<p>Code snippets appearing in <code class="language-plaintext highlighter-rouge">this style</code> are to be interpreted as Python 3 code.</p>

<h2 id="custom-types">Custom types</h2>

<p>We define the following Python custom types for type hinting and readability:</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>SSZ equivalent</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Slot</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64</code></td>
      <td>a slot number</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Epoch</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64</code></td>
      <td>an epoch number</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">CommitteeIndex</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64</code></td>
      <td>a committee index at a slot</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ValidatorIndex</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64</code></td>
      <td>a validator registry index</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Gwei</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64</code></td>
      <td>an amount in Gwei</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Root</code></td>
      <td><code class="language-plaintext highlighter-rouge">Bytes32</code></td>
      <td>a Merkle root</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Version</code></td>
      <td><code class="language-plaintext highlighter-rouge">Bytes4</code></td>
      <td>a fork version number</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">DomainType</code></td>
      <td><code class="language-plaintext highlighter-rouge">Bytes4</code></td>
      <td>a domain type</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ForkDigest</code></td>
      <td><code class="language-plaintext highlighter-rouge">Bytes4</code></td>
      <td>a digest of the current fork data</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Domain</code></td>
      <td><code class="language-plaintext highlighter-rouge">Bytes32</code></td>
      <td>a signature domain</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">BLSPubkey</code></td>
      <td><code class="language-plaintext highlighter-rouge">Bytes48</code></td>
      <td>a BLS12-381 public key</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">BLSSignature</code></td>
      <td><code class="language-plaintext highlighter-rouge">Bytes96</code></td>
      <td>a BLS12-381 signature</td>
    </tr>
  </tbody>
</table>

<h2 id="constants">Constants</h2>

<p>The following values are (non-configurable) constants used throughout the specification.</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">GENESIS_SLOT</code></td>
      <td><code class="language-plaintext highlighter-rouge">Slot(0)</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">GENESIS_EPOCH</code></td>
      <td><code class="language-plaintext highlighter-rouge">Epoch(0)</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">FAR_FUTURE_EPOCH</code></td>
      <td><code class="language-plaintext highlighter-rouge">Epoch(2**64 - 1)</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">BASE_REWARDS_PER_EPOCH</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(4)</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">DEPOSIT_CONTRACT_TREE_DEPTH</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**5)</code> (= 32)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">JUSTIFICATION_BITS_LENGTH</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(4)</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ENDIANNESS</code></td>
      <td><code class="language-plaintext highlighter-rouge">'little'</code></td>
    </tr>
  </tbody>
</table>

<h2 id="configuration">Configuration</h2>

<p><em>Note</em>: The default mainnet configuration values are included here for illustrative purposes. The different configurations for mainnet, testnets, and YAML-based testing can be found in the <a href="../../configs"><code class="language-plaintext highlighter-rouge">configs/constant_presets</code></a> directory.</p>

<h3 id="misc">Misc</h3>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ETH1_FOLLOW_DISTANCE</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**11)</code> (= 2,048)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MAX_COMMITTEES_PER_SLOT</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**6)</code> (= 64)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">TARGET_COMMITTEE_SIZE</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**7)</code> (= 128)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MAX_VALIDATORS_PER_COMMITTEE</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**11)</code> (= 2,048)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MIN_PER_EPOCH_CHURN_LIMIT</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**2)</code> (= 4)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">CHURN_LIMIT_QUOTIENT</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**16)</code> (= 65,536)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">SHUFFLE_ROUND_COUNT</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(90)</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MIN_GENESIS_ACTIVE_VALIDATOR_COUNT</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**14)</code> (= 16,384)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MIN_GENESIS_TIME</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(1606824000)</code> (Dec 1, 2020, 12pm UTC)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">HYSTERESIS_QUOTIENT</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(4)</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">HYSTERESIS_DOWNWARD_MULTIPLIER</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(1)</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">HYSTERESIS_UPWARD_MULTIPLIER</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(5)</code></td>
    </tr>
  </tbody>
</table>

<ul>
  <li>For the safety of committees, <code class="language-plaintext highlighter-rouge">TARGET_COMMITTEE_SIZE</code> exceeds <a href="http://web.archive.org/web/20190504131341/https://vitalik.ca/files/Ithaca201807_Sharding.pdf">the recommended minimum committee size of 111</a>; with sufficient active validators (at least <code class="language-plaintext highlighter-rouge">SLOTS_PER_EPOCH * TARGET_COMMITTEE_SIZE</code>), the shuffling algorithm ensures committee sizes of at least <code class="language-plaintext highlighter-rouge">TARGET_COMMITTEE_SIZE</code>. (Unbiasable randomness with a Verifiable Delay Function (VDF) will improve committee robustness and lower the safe minimum committee size.)</li>
</ul>

<h3 id="gwei-values">Gwei values</h3>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MIN_DEPOSIT_AMOUNT</code></td>
      <td><code class="language-plaintext highlighter-rouge">Gwei(2**0 * 10**9)</code> (= 1,000,000,000)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MAX_EFFECTIVE_BALANCE</code></td>
      <td><code class="language-plaintext highlighter-rouge">Gwei(2**5 * 10**9)</code> (= 32,000,000,000)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">EJECTION_BALANCE</code></td>
      <td><code class="language-plaintext highlighter-rouge">Gwei(2**4 * 10**9)</code> (= 16,000,000,000)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">EFFECTIVE_BALANCE_INCREMENT</code></td>
      <td><code class="language-plaintext highlighter-rouge">Gwei(2**0 * 10**9)</code> (= 1,000,000,000)</td>
    </tr>
  </tbody>
</table>

<h3 id="initial-values">Initial values</h3>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">GENESIS_FORK_VERSION</code></td>
      <td><code class="language-plaintext highlighter-rouge">Version('0x00000000')</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">BLS_WITHDRAWAL_PREFIX</code></td>
      <td><code class="language-plaintext highlighter-rouge">Bytes1('0x00')</code></td>
    </tr>
  </tbody>
</table>

<h3 id="time-parameters">Time parameters</h3>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Value</th>
      <th style="text-align: center">Unit</th>
      <th style="text-align: center">Duration</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">GENESIS_DELAY</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(604800)</code></td>
      <td style="text-align: center">seconds</td>
      <td style="text-align: center">7 days</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">SECONDS_PER_SLOT</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(12)</code></td>
      <td style="text-align: center">seconds</td>
      <td style="text-align: center">12 seconds</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">SECONDS_PER_ETH1_BLOCK</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(14)</code></td>
      <td style="text-align: center">seconds</td>
      <td style="text-align: center">14 seconds</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MIN_ATTESTATION_INCLUSION_DELAY</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**0)</code> (= 1)</td>
      <td style="text-align: center">slots</td>
      <td style="text-align: center">12 seconds</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">SLOTS_PER_EPOCH</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**5)</code> (= 32)</td>
      <td style="text-align: center">slots</td>
      <td style="text-align: center">6.4 minutes</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MIN_SEED_LOOKAHEAD</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**0)</code> (= 1)</td>
      <td style="text-align: center">epochs</td>
      <td style="text-align: center">6.4 minutes</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MAX_SEED_LOOKAHEAD</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**2)</code> (= 4)</td>
      <td style="text-align: center">epochs</td>
      <td style="text-align: center">25.6 minutes</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MIN_EPOCHS_TO_INACTIVITY_PENALTY</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**2)</code> (= 4)</td>
      <td style="text-align: center">epochs</td>
      <td style="text-align: center">25.6 minutes</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">EPOCHS_PER_ETH1_VOTING_PERIOD</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**6)</code> (= 64)</td>
      <td style="text-align: center">epochs</td>
      <td style="text-align: center">~6.8 hours</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">SLOTS_PER_HISTORICAL_ROOT</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**13)</code> (= 8,192)</td>
      <td style="text-align: center">slots</td>
      <td style="text-align: center">~27 hours</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MIN_VALIDATOR_WITHDRAWABILITY_DELAY</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**8)</code> (= 256)</td>
      <td style="text-align: center">epochs</td>
      <td style="text-align: center">~27 hours</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">SHARD_COMMITTEE_PERIOD</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**8)</code> (= 256)</td>
      <td style="text-align: center">epochs</td>
      <td style="text-align: center">~27 hours</td>
    </tr>
  </tbody>
</table>

<h3 id="state-list-lengths">State list lengths</h3>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Value</th>
      <th style="text-align: center">Unit</th>
      <th style="text-align: center">Duration</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">EPOCHS_PER_HISTORICAL_VECTOR</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**16)</code> (= 65,536)</td>
      <td style="text-align: center">epochs</td>
      <td style="text-align: center">~0.8 years</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">EPOCHS_PER_SLASHINGS_VECTOR</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**13)</code> (= 8,192)</td>
      <td style="text-align: center">epochs</td>
      <td style="text-align: center">~36 days</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">HISTORICAL_ROOTS_LIMIT</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**24)</code> (= 16,777,216)</td>
      <td style="text-align: center">historical roots</td>
      <td style="text-align: center">~52,262 years</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">VALIDATOR_REGISTRY_LIMIT</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**40)</code> (= 1,099,511,627,776)</td>
      <td style="text-align: center">validators</td>
      <td style="text-align: center"> </td>
    </tr>
  </tbody>
</table>

<h3 id="rewards-and-penalties">Rewards and penalties</h3>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">BASE_REWARD_FACTOR</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**6)</code> (= 64)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">WHISTLEBLOWER_REWARD_QUOTIENT</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**9)</code> (= 512)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">PROPOSER_REWARD_QUOTIENT</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**3)</code> (= 8)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">INACTIVITY_PENALTY_QUOTIENT</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**26)</code> (= 67,108,864)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MIN_SLASHING_PENALTY_QUOTIENT</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(2**7)</code> (=128)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">PROPORTIONAL_SLASHING_MULTIPLIER</code></td>
      <td><code class="language-plaintext highlighter-rouge">uint64(1)</code></td>
    </tr>
  </tbody>
</table>

<ul>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">INACTIVITY_PENALTY_QUOTIENT</code> equals <code class="language-plaintext highlighter-rouge">INVERSE_SQRT_E_DROP_TIME**2</code> where <code class="language-plaintext highlighter-rouge">INVERSE_SQRT_E_DROP_TIME := 2**13</code> epochs (about 36 days) is the time it takes the inactivity penalty to reduce the balance of non-participating validators to about <code class="language-plaintext highlighter-rouge">1/sqrt(e) ~= 60.6%</code>. Indeed, the balance retained by offline validators after <code class="language-plaintext highlighter-rouge">n</code> epochs is about <code class="language-plaintext highlighter-rouge">(1 - 1/INACTIVITY_PENALTY_QUOTIENT)**(n**2/2)</code>; so after <code class="language-plaintext highlighter-rouge">INVERSE_SQRT_E_DROP_TIME</code> epochs, it is roughly <code class="language-plaintext highlighter-rouge">(1 - 1/INACTIVITY_PENALTY_QUOTIENT)**(INACTIVITY_PENALTY_QUOTIENT/2) ~= 1/sqrt(e)</code>. Note this value will be upgraded to <code class="language-plaintext highlighter-rouge">2**24</code> after Phase 0 mainnet stabilizes to provide a faster recovery in the event of an inactivity leak.</p>
  </li>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">PROPORTIONAL_SLASHING_MULTIPLIER</code> is set to <code class="language-plaintext highlighter-rouge">1</code> at initial mainnet launch, resulting in one-third of the minimum accountable safety margin in the event of a finality attack. After Phase 0 mainnet stablizes, this value will be upgraded to <code class="language-plaintext highlighter-rouge">3</code> to provide the maximal minimum accountable safety margin.</p>
  </li>
</ul>

<h3 id="max-operations-per-block">Max operations per block</h3>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MAX_PROPOSER_SLASHINGS</code></td>
      <td><code class="language-plaintext highlighter-rouge">2**4</code> (= 16)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MAX_ATTESTER_SLASHINGS</code></td>
      <td><code class="language-plaintext highlighter-rouge">2**1</code> (= 2)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MAX_ATTESTATIONS</code></td>
      <td><code class="language-plaintext highlighter-rouge">2**7</code> (= 128)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MAX_DEPOSITS</code></td>
      <td><code class="language-plaintext highlighter-rouge">2**4</code> (= 16)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MAX_VOLUNTARY_EXITS</code></td>
      <td><code class="language-plaintext highlighter-rouge">2**4</code> (= 16)</td>
    </tr>
  </tbody>
</table>

<h3 id="domain-types">Domain types</h3>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">DOMAIN_BEACON_PROPOSER</code></td>
      <td><code class="language-plaintext highlighter-rouge">DomainType('0x00000000')</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">DOMAIN_BEACON_ATTESTER</code></td>
      <td><code class="language-plaintext highlighter-rouge">DomainType('0x01000000')</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">DOMAIN_RANDAO</code></td>
      <td><code class="language-plaintext highlighter-rouge">DomainType('0x02000000')</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">DOMAIN_DEPOSIT</code></td>
      <td><code class="language-plaintext highlighter-rouge">DomainType('0x03000000')</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">DOMAIN_VOLUNTARY_EXIT</code></td>
      <td><code class="language-plaintext highlighter-rouge">DomainType('0x04000000')</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">DOMAIN_SELECTION_PROOF</code></td>
      <td><code class="language-plaintext highlighter-rouge">DomainType('0x05000000')</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">DOMAIN_AGGREGATE_AND_PROOF</code></td>
      <td><code class="language-plaintext highlighter-rouge">DomainType('0x06000000')</code></td>
    </tr>
  </tbody>
</table>

<h2 id="containers">Containers</h2>

<p>The following types are <a href="/eth2specs/ssz/simple-serialize.html">SimpleSerialize (SSZ)</a> containers.</p>

<p><em>Note</em>: The definitions are ordered topologically to facilitate execution of the spec.</p>

<p><em>Note</em>: Fields missing in container instantiations default to their zero value.</p>

<h3 id="misc-dependencies">Misc dependencies</h3>

<h4 id="fork"><code class="language-plaintext highlighter-rouge">Fork</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Fork</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">previous_version</span><span class="p">:</span> <span class="n">Version</span>
    <span class="n">current_version</span><span class="p">:</span> <span class="n">Version</span>
    <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span>  <span class="c1"># Epoch of latest fork
</span></code></pre></div></div>

<h4 id="forkdata"><code class="language-plaintext highlighter-rouge">ForkData</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ForkData</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">current_version</span><span class="p">:</span> <span class="n">Version</span>
    <span class="n">genesis_validators_root</span><span class="p">:</span> <span class="n">Root</span>
</code></pre></div></div>

<h4 id="checkpoint"><code class="language-plaintext highlighter-rouge">Checkpoint</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Checkpoint</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span>
    <span class="n">root</span><span class="p">:</span> <span class="n">Root</span>
</code></pre></div></div>

<h4 id="validator"><code class="language-plaintext highlighter-rouge">Validator</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Validator</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">pubkey</span><span class="p">:</span> <span class="n">BLSPubkey</span>
    <span class="n">withdrawal_credentials</span><span class="p">:</span> <span class="n">Bytes32</span>  <span class="c1"># Commitment to pubkey for withdrawals
</span>    <span class="n">effective_balance</span><span class="p">:</span> <span class="n">Gwei</span>  <span class="c1"># Balance at stake
</span>    <span class="n">slashed</span><span class="p">:</span> <span class="n">boolean</span>
    <span class="c1"># Status epochs
</span>    <span class="n">activation_eligibility_epoch</span><span class="p">:</span> <span class="n">Epoch</span>  <span class="c1"># When criteria for activation were met
</span>    <span class="n">activation_epoch</span><span class="p">:</span> <span class="n">Epoch</span>
    <span class="n">exit_epoch</span><span class="p">:</span> <span class="n">Epoch</span>
    <span class="n">withdrawable_epoch</span><span class="p">:</span> <span class="n">Epoch</span>  <span class="c1"># When validator can withdraw funds
</span></code></pre></div></div>

<h4 id="attestationdata"><code class="language-plaintext highlighter-rouge">AttestationData</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AttestationData</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">slot</span><span class="p">:</span> <span class="n">Slot</span>
    <span class="n">index</span><span class="p">:</span> <span class="n">CommitteeIndex</span>
    <span class="c1"># LMD GHOST vote
</span>    <span class="n">beacon_block_root</span><span class="p">:</span> <span class="n">Root</span>
    <span class="c1"># FFG vote
</span>    <span class="n">source</span><span class="p">:</span> <span class="n">Checkpoint</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">Checkpoint</span>
</code></pre></div></div>

<h4 id="indexedattestation"><code class="language-plaintext highlighter-rouge">IndexedAttestation</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">IndexedAttestation</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">attesting_indices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ValidatorIndex</span><span class="p">,</span> <span class="n">MAX_VALIDATORS_PER_COMMITTEE</span><span class="p">]</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">AttestationData</span>
    <span class="n">signature</span><span class="p">:</span> <span class="n">BLSSignature</span>
</code></pre></div></div>

<h4 id="pendingattestation"><code class="language-plaintext highlighter-rouge">PendingAttestation</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PendingAttestation</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">aggregation_bits</span><span class="p">:</span> <span class="n">Bitlist</span><span class="p">[</span><span class="n">MAX_VALIDATORS_PER_COMMITTEE</span><span class="p">]</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">AttestationData</span>
    <span class="n">inclusion_delay</span><span class="p">:</span> <span class="n">Slot</span>
    <span class="n">proposer_index</span><span class="p">:</span> <span class="n">ValidatorIndex</span>
</code></pre></div></div>

<h4 id="eth1data"><code class="language-plaintext highlighter-rouge">Eth1Data</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Eth1Data</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">deposit_root</span><span class="p">:</span> <span class="n">Root</span>
    <span class="n">deposit_count</span><span class="p">:</span> <span class="n">uint64</span>
    <span class="n">block_hash</span><span class="p">:</span> <span class="n">Bytes32</span>
</code></pre></div></div>

<h4 id="historicalbatch"><code class="language-plaintext highlighter-rouge">HistoricalBatch</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">HistoricalBatch</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">block_roots</span><span class="p">:</span> <span class="n">Vector</span><span class="p">[</span><span class="n">Root</span><span class="p">,</span> <span class="n">SLOTS_PER_HISTORICAL_ROOT</span><span class="p">]</span>
    <span class="n">state_roots</span><span class="p">:</span> <span class="n">Vector</span><span class="p">[</span><span class="n">Root</span><span class="p">,</span> <span class="n">SLOTS_PER_HISTORICAL_ROOT</span><span class="p">]</span>
</code></pre></div></div>

<h4 id="depositmessage"><code class="language-plaintext highlighter-rouge">DepositMessage</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DepositMessage</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">pubkey</span><span class="p">:</span> <span class="n">BLSPubkey</span>
    <span class="n">withdrawal_credentials</span><span class="p">:</span> <span class="n">Bytes32</span>
    <span class="n">amount</span><span class="p">:</span> <span class="n">Gwei</span>
</code></pre></div></div>

<h4 id="depositdata"><code class="language-plaintext highlighter-rouge">DepositData</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DepositData</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">pubkey</span><span class="p">:</span> <span class="n">BLSPubkey</span>
    <span class="n">withdrawal_credentials</span><span class="p">:</span> <span class="n">Bytes32</span>
    <span class="n">amount</span><span class="p">:</span> <span class="n">Gwei</span>
    <span class="n">signature</span><span class="p">:</span> <span class="n">BLSSignature</span>  <span class="c1"># Signing over DepositMessage
</span></code></pre></div></div>

<h4 id="beaconblockheader"><code class="language-plaintext highlighter-rouge">BeaconBlockHeader</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BeaconBlockHeader</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">slot</span><span class="p">:</span> <span class="n">Slot</span>
    <span class="n">proposer_index</span><span class="p">:</span> <span class="n">ValidatorIndex</span>
    <span class="n">parent_root</span><span class="p">:</span> <span class="n">Root</span>
    <span class="n">state_root</span><span class="p">:</span> <span class="n">Root</span>
    <span class="n">body_root</span><span class="p">:</span> <span class="n">Root</span>
</code></pre></div></div>

<h4 id="signingdata"><code class="language-plaintext highlighter-rouge">SigningData</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SigningData</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">object_root</span><span class="p">:</span> <span class="n">Root</span>
    <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span>
</code></pre></div></div>

<h3 id="beacon-operations">Beacon operations</h3>

<h4 id="proposerslashing"><code class="language-plaintext highlighter-rouge">ProposerSlashing</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ProposerSlashing</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">signed_header_1</span><span class="p">:</span> <span class="n">SignedBeaconBlockHeader</span>
    <span class="n">signed_header_2</span><span class="p">:</span> <span class="n">SignedBeaconBlockHeader</span>
</code></pre></div></div>

<h4 id="attesterslashing"><code class="language-plaintext highlighter-rouge">AttesterSlashing</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AttesterSlashing</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">attestation_1</span><span class="p">:</span> <span class="n">IndexedAttestation</span>
    <span class="n">attestation_2</span><span class="p">:</span> <span class="n">IndexedAttestation</span>
</code></pre></div></div>

<h4 id="attestation"><code class="language-plaintext highlighter-rouge">Attestation</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Attestation</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">aggregation_bits</span><span class="p">:</span> <span class="n">Bitlist</span><span class="p">[</span><span class="n">MAX_VALIDATORS_PER_COMMITTEE</span><span class="p">]</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">AttestationData</span>
    <span class="n">signature</span><span class="p">:</span> <span class="n">BLSSignature</span>
</code></pre></div></div>

<h4 id="deposit"><code class="language-plaintext highlighter-rouge">Deposit</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Deposit</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">proof</span><span class="p">:</span> <span class="n">Vector</span><span class="p">[</span><span class="n">Bytes32</span><span class="p">,</span> <span class="n">DEPOSIT_CONTRACT_TREE_DEPTH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># Merkle path to deposit root
</span>    <span class="n">data</span><span class="p">:</span> <span class="n">DepositData</span>
</code></pre></div></div>

<h4 id="voluntaryexit"><code class="language-plaintext highlighter-rouge">VoluntaryExit</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">VoluntaryExit</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span>  <span class="c1"># Earliest epoch when voluntary exit can be processed
</span>    <span class="n">validator_index</span><span class="p">:</span> <span class="n">ValidatorIndex</span>
</code></pre></div></div>

<h3 id="beacon-blocks">Beacon blocks</h3>

<h4 id="beaconblockbody"><code class="language-plaintext highlighter-rouge">BeaconBlockBody</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BeaconBlockBody</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">randao_reveal</span><span class="p">:</span> <span class="n">BLSSignature</span>
    <span class="n">eth1_data</span><span class="p">:</span> <span class="n">Eth1Data</span>  <span class="c1"># Eth1 data vote
</span>    <span class="n">graffiti</span><span class="p">:</span> <span class="n">Bytes32</span>  <span class="c1"># Arbitrary data
</span>    <span class="c1"># Operations
</span>    <span class="n">proposer_slashings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ProposerSlashing</span><span class="p">,</span> <span class="n">MAX_PROPOSER_SLASHINGS</span><span class="p">]</span>
    <span class="n">attester_slashings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">AttesterSlashing</span><span class="p">,</span> <span class="n">MAX_ATTESTER_SLASHINGS</span><span class="p">]</span>
    <span class="n">attestations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Attestation</span><span class="p">,</span> <span class="n">MAX_ATTESTATIONS</span><span class="p">]</span>
    <span class="n">deposits</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Deposit</span><span class="p">,</span> <span class="n">MAX_DEPOSITS</span><span class="p">]</span>
    <span class="n">voluntary_exits</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SignedVoluntaryExit</span><span class="p">,</span> <span class="n">MAX_VOLUNTARY_EXITS</span><span class="p">]</span>
</code></pre></div></div>

<h4 id="beaconblock"><code class="language-plaintext highlighter-rouge">BeaconBlock</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BeaconBlock</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">slot</span><span class="p">:</span> <span class="n">Slot</span>
    <span class="n">proposer_index</span><span class="p">:</span> <span class="n">ValidatorIndex</span>
    <span class="n">parent_root</span><span class="p">:</span> <span class="n">Root</span>
    <span class="n">state_root</span><span class="p">:</span> <span class="n">Root</span>
    <span class="n">body</span><span class="p">:</span> <span class="n">BeaconBlockBody</span>
</code></pre></div></div>

<h3 id="beacon-state">Beacon state</h3>

<h4 id="beaconstate"><code class="language-plaintext highlighter-rouge">BeaconState</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BeaconState</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="c1"># Versioning
</span>    <span class="n">genesis_time</span><span class="p">:</span> <span class="n">uint64</span>
    <span class="n">genesis_validators_root</span><span class="p">:</span> <span class="n">Root</span>
    <span class="n">slot</span><span class="p">:</span> <span class="n">Slot</span>
    <span class="n">fork</span><span class="p">:</span> <span class="n">Fork</span>
    <span class="c1"># History
</span>    <span class="n">latest_block_header</span><span class="p">:</span> <span class="n">BeaconBlockHeader</span>
    <span class="n">block_roots</span><span class="p">:</span> <span class="n">Vector</span><span class="p">[</span><span class="n">Root</span><span class="p">,</span> <span class="n">SLOTS_PER_HISTORICAL_ROOT</span><span class="p">]</span>
    <span class="n">state_roots</span><span class="p">:</span> <span class="n">Vector</span><span class="p">[</span><span class="n">Root</span><span class="p">,</span> <span class="n">SLOTS_PER_HISTORICAL_ROOT</span><span class="p">]</span>
    <span class="n">historical_roots</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Root</span><span class="p">,</span> <span class="n">HISTORICAL_ROOTS_LIMIT</span><span class="p">]</span>
    <span class="c1"># Eth1
</span>    <span class="n">eth1_data</span><span class="p">:</span> <span class="n">Eth1Data</span>
    <span class="n">eth1_data_votes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Eth1Data</span><span class="p">,</span> <span class="n">EPOCHS_PER_ETH1_VOTING_PERIOD</span> <span class="o">*</span> <span class="n">SLOTS_PER_EPOCH</span><span class="p">]</span>
    <span class="n">eth1_deposit_index</span><span class="p">:</span> <span class="n">uint64</span>
    <span class="c1"># Registry
</span>    <span class="n">validators</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Validator</span><span class="p">,</span> <span class="n">VALIDATOR_REGISTRY_LIMIT</span><span class="p">]</span>
    <span class="n">balances</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Gwei</span><span class="p">,</span> <span class="n">VALIDATOR_REGISTRY_LIMIT</span><span class="p">]</span>
    <span class="c1"># Randomness
</span>    <span class="n">randao_mixes</span><span class="p">:</span> <span class="n">Vector</span><span class="p">[</span><span class="n">Bytes32</span><span class="p">,</span> <span class="n">EPOCHS_PER_HISTORICAL_VECTOR</span><span class="p">]</span>
    <span class="c1"># Slashings
</span>    <span class="n">slashings</span><span class="p">:</span> <span class="n">Vector</span><span class="p">[</span><span class="n">Gwei</span><span class="p">,</span> <span class="n">EPOCHS_PER_SLASHINGS_VECTOR</span><span class="p">]</span>  <span class="c1"># Per-epoch sums of slashed effective balances
</span>    <span class="c1"># Attestations
</span>    <span class="n">previous_epoch_attestations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PendingAttestation</span><span class="p">,</span> <span class="n">MAX_ATTESTATIONS</span> <span class="o">*</span> <span class="n">SLOTS_PER_EPOCH</span><span class="p">]</span>
    <span class="n">current_epoch_attestations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PendingAttestation</span><span class="p">,</span> <span class="n">MAX_ATTESTATIONS</span> <span class="o">*</span> <span class="n">SLOTS_PER_EPOCH</span><span class="p">]</span>
    <span class="c1"># Finality
</span>    <span class="n">justification_bits</span><span class="p">:</span> <span class="n">Bitvector</span><span class="p">[</span><span class="n">JUSTIFICATION_BITS_LENGTH</span><span class="p">]</span>  <span class="c1"># Bit set for every recent justified epoch
</span>    <span class="n">previous_justified_checkpoint</span><span class="p">:</span> <span class="n">Checkpoint</span>  <span class="c1"># Previous epoch snapshot
</span>    <span class="n">current_justified_checkpoint</span><span class="p">:</span> <span class="n">Checkpoint</span>
    <span class="n">finalized_checkpoint</span><span class="p">:</span> <span class="n">Checkpoint</span>
</code></pre></div></div>

<h3 id="signed-envelopes">Signed envelopes</h3>

<h4 id="signedvoluntaryexit"><code class="language-plaintext highlighter-rouge">SignedVoluntaryExit</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SignedVoluntaryExit</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">message</span><span class="p">:</span> <span class="n">VoluntaryExit</span>
    <span class="n">signature</span><span class="p">:</span> <span class="n">BLSSignature</span>
</code></pre></div></div>

<h4 id="signedbeaconblock"><code class="language-plaintext highlighter-rouge">SignedBeaconBlock</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SignedBeaconBlock</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">message</span><span class="p">:</span> <span class="n">BeaconBlock</span>
    <span class="n">signature</span><span class="p">:</span> <span class="n">BLSSignature</span>
</code></pre></div></div>

<h4 id="signedbeaconblockheader"><code class="language-plaintext highlighter-rouge">SignedBeaconBlockHeader</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SignedBeaconBlockHeader</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">message</span><span class="p">:</span> <span class="n">BeaconBlockHeader</span>
    <span class="n">signature</span><span class="p">:</span> <span class="n">BLSSignature</span>
</code></pre></div></div>

<h2 id="helper-functions">Helper functions</h2>

<p><em>Note</em>: The definitions below are for specification purposes and are not necessarily optimal implementations.</p>

<h3 id="math">Math</h3>

<h4 id="integer_squareroot"><code class="language-plaintext highlighter-rouge">integer_squareroot</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">integer_squareroot</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="n">uint64</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">uint64</span><span class="p">:</span>
    <span class="s">"""
    Return the largest integer ``x`` such that ``x**2 &lt;= n``.
    """</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">n</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">while</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">n</span> <span class="o">//</span> <span class="n">x</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></div>

<h4 id="xor"><code class="language-plaintext highlighter-rouge">xor</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">xor</span><span class="p">(</span><span class="n">bytes_1</span><span class="p">:</span> <span class="n">Bytes32</span><span class="p">,</span> <span class="n">bytes_2</span><span class="p">:</span> <span class="n">Bytes32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Bytes32</span><span class="p">:</span>
    <span class="s">"""
    Return the exclusive-or of two 32-byte strings.
    """</span>
    <span class="k">return</span> <span class="n">Bytes32</span><span class="p">(</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bytes_1</span><span class="p">,</span> <span class="n">bytes_2</span><span class="p">))</span>
</code></pre></div></div>

<h4 id="uint_to_bytes"><code class="language-plaintext highlighter-rouge">uint_to_bytes</code></h4>

<p><code class="language-plaintext highlighter-rouge">def uint_to_bytes(n: uint) -&gt; bytes</code> is a function for serializing the <code class="language-plaintext highlighter-rouge">uint</code> type object to bytes in <code class="language-plaintext highlighter-rouge">ENDIANNESS</code>-endian. The expected length of the output is the byte-length of the <code class="language-plaintext highlighter-rouge">uint</code> type.</p>

<h4 id="bytes_to_uint64"><code class="language-plaintext highlighter-rouge">bytes_to_uint64</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">bytes_to_uint64</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">uint64</span><span class="p">:</span>
    <span class="s">"""
    Return the integer deserialization of ``data`` interpreted as ``ENDIANNESS``-endian.
    """</span>
    <span class="k">return</span> <span class="n">uint64</span><span class="p">(</span><span class="nb">int</span><span class="p">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ENDIANNESS</span><span class="p">))</span>
</code></pre></div></div>

<h3 id="crypto">Crypto</h3>

<h4 id="hash"><code class="language-plaintext highlighter-rouge">hash</code></h4>

<p><code class="language-plaintext highlighter-rouge">def hash(data: bytes) -&gt; Bytes32</code> is SHA256.</p>

<h4 id="hash_tree_root"><code class="language-plaintext highlighter-rouge">hash_tree_root</code></h4>

<p><code class="language-plaintext highlighter-rouge">def hash_tree_root(object: SSZSerializable) -&gt; Root</code> is a function for hashing objects into a single root by utilizing a hash tree structure, as defined in the <a href="/eth2specs/ssz/simple-serialize.html#merkleization">SSZ spec</a>.</p>

<h4 id="bls-signatures">BLS signatures</h4>

<p>The <a href="https://tools.ietf.org/html/draft-irtf-cfrg-bls-signature-04">IETF BLS signature draft standard v4</a> with ciphersuite <code class="language-plaintext highlighter-rouge">BLS_SIG_BLS12381G2_XMD:SHA-256_SSWU_RO_POP_</code> defines the following functions:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">def Sign(privkey: int, message: Bytes) -&gt; BLSSignature</code></li>
  <li><code class="language-plaintext highlighter-rouge">def Verify(pubkey: BLSPubkey, message: Bytes, signature: BLSSignature) -&gt; bool</code></li>
  <li><code class="language-plaintext highlighter-rouge">def Aggregate(signatures: Sequence[BLSSignature]) -&gt; BLSSignature</code></li>
  <li><code class="language-plaintext highlighter-rouge">def FastAggregateVerify(pubkeys: Sequence[BLSPubkey], message: Bytes, signature: BLSSignature) -&gt; bool</code></li>
  <li><code class="language-plaintext highlighter-rouge">def AggregateVerify(pubkeys: Sequence[BLSPubkey], messages: Sequence[Bytes], signature: BLSSignature) -&gt; bool</code></li>
</ul>

<p>The above functions are accessed through the <code class="language-plaintext highlighter-rouge">bls</code> module, e.g. <code class="language-plaintext highlighter-rouge">bls.Verify</code>.</p>

<h3 id="predicates">Predicates</h3>

<h4 id="is_active_validator"><code class="language-plaintext highlighter-rouge">is_active_validator</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">is_active_validator</span><span class="p">(</span><span class="n">validator</span><span class="p">:</span> <span class="n">Validator</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="s">"""
    Check if ``validator`` is active.
    """</span>
    <span class="k">return</span> <span class="n">validator</span><span class="p">.</span><span class="n">activation_epoch</span> <span class="o">&lt;=</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="n">validator</span><span class="p">.</span><span class="n">exit_epoch</span>
</code></pre></div></div>

<h4 id="is_eligible_for_activation_queue"><code class="language-plaintext highlighter-rouge">is_eligible_for_activation_queue</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">is_eligible_for_activation_queue</span><span class="p">(</span><span class="n">validator</span><span class="p">:</span> <span class="n">Validator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="s">"""
    Check if ``validator`` is eligible to be placed into the activation queue.
    """</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">validator</span><span class="p">.</span><span class="n">activation_eligibility_epoch</span> <span class="o">==</span> <span class="n">FAR_FUTURE_EPOCH</span>
        <span class="ow">and</span> <span class="n">validator</span><span class="p">.</span><span class="n">effective_balance</span> <span class="o">==</span> <span class="n">MAX_EFFECTIVE_BALANCE</span>
    <span class="p">)</span>
</code></pre></div></div>

<h4 id="is_eligible_for_activation"><code class="language-plaintext highlighter-rouge">is_eligible_for_activation</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">is_eligible_for_activation</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">validator</span><span class="p">:</span> <span class="n">Validator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="s">"""
    Check if ``validator`` is eligible for activation.
    """</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="c1"># Placement in queue is finalized
</span>        <span class="n">validator</span><span class="p">.</span><span class="n">activation_eligibility_epoch</span> <span class="o">&lt;=</span> <span class="n">state</span><span class="p">.</span><span class="n">finalized_checkpoint</span><span class="p">.</span><span class="n">epoch</span>
        <span class="c1"># Has not yet been activated
</span>        <span class="ow">and</span> <span class="n">validator</span><span class="p">.</span><span class="n">activation_epoch</span> <span class="o">==</span> <span class="n">FAR_FUTURE_EPOCH</span>
    <span class="p">)</span>
</code></pre></div></div>

<h4 id="is_slashable_validator"><code class="language-plaintext highlighter-rouge">is_slashable_validator</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">is_slashable_validator</span><span class="p">(</span><span class="n">validator</span><span class="p">:</span> <span class="n">Validator</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="s">"""
    Check if ``validator`` is slashable.
    """</span>
    <span class="k">return</span> <span class="p">(</span><span class="ow">not</span> <span class="n">validator</span><span class="p">.</span><span class="n">slashed</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">validator</span><span class="p">.</span><span class="n">activation_epoch</span> <span class="o">&lt;=</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="n">validator</span><span class="p">.</span><span class="n">withdrawable_epoch</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="is_slashable_attestation_data"><code class="language-plaintext highlighter-rouge">is_slashable_attestation_data</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">is_slashable_attestation_data</span><span class="p">(</span><span class="n">data_1</span><span class="p">:</span> <span class="n">AttestationData</span><span class="p">,</span> <span class="n">data_2</span><span class="p">:</span> <span class="n">AttestationData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="s">"""
    Check if ``data_1`` and ``data_2`` are slashable according to Casper FFG rules.
    """</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="c1"># Double vote
</span>        <span class="p">(</span><span class="n">data_1</span> <span class="o">!=</span> <span class="n">data_2</span> <span class="ow">and</span> <span class="n">data_1</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">epoch</span> <span class="o">==</span> <span class="n">data_2</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">epoch</span><span class="p">)</span> <span class="ow">or</span>
        <span class="c1"># Surround vote
</span>        <span class="p">(</span><span class="n">data_1</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">epoch</span> <span class="o">&lt;</span> <span class="n">data_2</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">epoch</span> <span class="ow">and</span> <span class="n">data_2</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">epoch</span> <span class="o">&lt;</span> <span class="n">data_1</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">epoch</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></div>

<h4 id="is_valid_indexed_attestation"><code class="language-plaintext highlighter-rouge">is_valid_indexed_attestation</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">is_valid_indexed_attestation</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">indexed_attestation</span><span class="p">:</span> <span class="n">IndexedAttestation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="s">"""
    Check if ``indexed_attestation`` is not empty, has sorted and unique indices and has a valid aggregate signature.
    """</span>
    <span class="c1"># Verify indices are sorted and unique
</span>    <span class="n">indices</span> <span class="o">=</span> <span class="n">indexed_attestation</span><span class="p">.</span><span class="n">attesting_indices</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">indices</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">indices</span><span class="p">)):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="c1"># Verify aggregate signature
</span>    <span class="n">pubkeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pubkey</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">get_domain</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DOMAIN_BEACON_ATTESTER</span><span class="p">,</span> <span class="n">indexed_attestation</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">epoch</span><span class="p">)</span>
    <span class="n">signing_root</span> <span class="o">=</span> <span class="n">compute_signing_root</span><span class="p">(</span><span class="n">indexed_attestation</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bls</span><span class="p">.</span><span class="n">FastAggregateVerify</span><span class="p">(</span><span class="n">pubkeys</span><span class="p">,</span> <span class="n">signing_root</span><span class="p">,</span> <span class="n">indexed_attestation</span><span class="p">.</span><span class="n">signature</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="is_valid_merkle_branch"><code class="language-plaintext highlighter-rouge">is_valid_merkle_branch</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">is_valid_merkle_branch</span><span class="p">(</span><span class="n">leaf</span><span class="p">:</span> <span class="n">Bytes32</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Bytes32</span><span class="p">],</span> <span class="n">depth</span><span class="p">:</span> <span class="n">uint64</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">uint64</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="n">Root</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="s">"""
    Check if ``leaf`` at ``index`` verifies against the Merkle ``root`` and ``branch``.
    """</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">leaf</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">branch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="n">branch</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">value</span> <span class="o">==</span> <span class="n">root</span>
</code></pre></div></div>

<h3 id="misc-1">Misc</h3>

<h4 id="compute_shuffled_index"><code class="language-plaintext highlighter-rouge">compute_shuffled_index</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">compute_shuffled_index</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="n">uint64</span><span class="p">,</span> <span class="n">index_count</span><span class="p">:</span> <span class="n">uint64</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">Bytes32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">uint64</span><span class="p">:</span>
    <span class="s">"""
    Return the shuffled index corresponding to ``seed`` (and ``index_count``).
    """</span>
    <span class="k">assert</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">index_count</span>

    <span class="c1"># Swap or not (https://link.springer.com/content/pdf/10.1007%2F978-3-642-32009-5_1.pdf)
</span>    <span class="c1"># See the 'generalized domain' algorithm on page 3
</span>    <span class="k">for</span> <span class="n">current_round</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SHUFFLE_ROUND_COUNT</span><span class="p">):</span>
        <span class="n">pivot</span> <span class="o">=</span> <span class="n">bytes_to_uint64</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">seed</span> <span class="o">+</span> <span class="n">uint_to_bytes</span><span class="p">(</span><span class="n">uint8</span><span class="p">(</span><span class="n">current_round</span><span class="p">)))[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span> <span class="o">%</span> <span class="n">index_count</span>
        <span class="n">flip</span> <span class="o">=</span> <span class="p">(</span><span class="n">pivot</span> <span class="o">+</span> <span class="n">index_count</span> <span class="o">-</span> <span class="n">index</span><span class="p">)</span> <span class="o">%</span> <span class="n">index_count</span>
        <span class="n">position</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">flip</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span>
            <span class="n">seed</span>
            <span class="o">+</span> <span class="n">uint_to_bytes</span><span class="p">(</span><span class="n">uint8</span><span class="p">(</span><span class="n">current_round</span><span class="p">))</span>
            <span class="o">+</span> <span class="n">uint_to_bytes</span><span class="p">(</span><span class="n">uint32</span><span class="p">(</span><span class="n">position</span> <span class="o">//</span> <span class="mi">256</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">byte</span> <span class="o">=</span> <span class="n">uint8</span><span class="p">(</span><span class="n">source</span><span class="p">[(</span><span class="n">position</span> <span class="o">%</span> <span class="mi">256</span><span class="p">)</span> <span class="o">//</span> <span class="mi">8</span><span class="p">])</span>
        <span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">position</span> <span class="o">%</span> <span class="mi">8</span><span class="p">))</span> <span class="o">%</span> <span class="mi">2</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">flip</span> <span class="k">if</span> <span class="n">bit</span> <span class="k">else</span> <span class="n">index</span>

    <span class="k">return</span> <span class="n">index</span>
</code></pre></div></div>

<h4 id="compute_proposer_index"><code class="language-plaintext highlighter-rouge">compute_proposer_index</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">compute_proposer_index</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ValidatorIndex</span><span class="p">],</span> <span class="n">seed</span><span class="p">:</span> <span class="n">Bytes32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ValidatorIndex</span><span class="p">:</span>
    <span class="s">"""
    Return from ``indices`` a random index sampled by effective balance.
    """</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">MAX_RANDOM_BYTE</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">uint64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">candidate_index</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">compute_shuffled_index</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">total</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">seed</span><span class="p">)]</span>
        <span class="n">random_byte</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">seed</span> <span class="o">+</span> <span class="n">uint_to_bytes</span><span class="p">(</span><span class="n">uint64</span><span class="p">(</span><span class="n">i</span> <span class="o">//</span> <span class="mi">32</span><span class="p">)))[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">32</span><span class="p">]</span>
        <span class="n">effective_balance</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">[</span><span class="n">candidate_index</span><span class="p">].</span><span class="n">effective_balance</span>
        <span class="k">if</span> <span class="n">effective_balance</span> <span class="o">*</span> <span class="n">MAX_RANDOM_BYTE</span> <span class="o">&gt;=</span> <span class="n">MAX_EFFECTIVE_BALANCE</span> <span class="o">*</span> <span class="n">random_byte</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">candidate_index</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></div>

<h4 id="compute_committee"><code class="language-plaintext highlighter-rouge">compute_committee</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">compute_committee</span><span class="p">(</span><span class="n">indices</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ValidatorIndex</span><span class="p">],</span>
                      <span class="n">seed</span><span class="p">:</span> <span class="n">Bytes32</span><span class="p">,</span>
                      <span class="n">index</span><span class="p">:</span> <span class="n">uint64</span><span class="p">,</span>
                      <span class="n">count</span><span class="p">:</span> <span class="n">uint64</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ValidatorIndex</span><span class="p">]:</span>
    <span class="s">"""
    Return the committee corresponding to ``indices``, ``seed``, ``index``, and committee ``count``.
    """</span>
    <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">*</span> <span class="n">index</span><span class="p">)</span> <span class="o">//</span> <span class="n">count</span>
    <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">*</span> <span class="n">uint64</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">//</span> <span class="n">count</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">compute_shuffled_index</span><span class="p">(</span><span class="n">uint64</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)),</span> <span class="n">seed</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)]</span>
</code></pre></div></div>

<h4 id="compute_epoch_at_slot"><code class="language-plaintext highlighter-rouge">compute_epoch_at_slot</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">compute_epoch_at_slot</span><span class="p">(</span><span class="n">slot</span><span class="p">:</span> <span class="n">Slot</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Epoch</span><span class="p">:</span>
    <span class="s">"""
    Return the epoch number at ``slot``.
    """</span>
    <span class="k">return</span> <span class="n">Epoch</span><span class="p">(</span><span class="n">slot</span> <span class="o">//</span> <span class="n">SLOTS_PER_EPOCH</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="compute_start_slot_at_epoch"><code class="language-plaintext highlighter-rouge">compute_start_slot_at_epoch</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">compute_start_slot_at_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Slot</span><span class="p">:</span>
    <span class="s">"""
    Return the start slot of ``epoch``.
    """</span>
    <span class="k">return</span> <span class="n">Slot</span><span class="p">(</span><span class="n">epoch</span> <span class="o">*</span> <span class="n">SLOTS_PER_EPOCH</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="compute_activation_exit_epoch"><code class="language-plaintext highlighter-rouge">compute_activation_exit_epoch</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">compute_activation_exit_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Epoch</span><span class="p">:</span>
    <span class="s">"""
    Return the epoch during which validator activations and exits initiated in ``epoch`` take effect.
    """</span>
    <span class="k">return</span> <span class="n">Epoch</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">MAX_SEED_LOOKAHEAD</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="compute_fork_data_root"><code class="language-plaintext highlighter-rouge">compute_fork_data_root</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">compute_fork_data_root</span><span class="p">(</span><span class="n">current_version</span><span class="p">:</span> <span class="n">Version</span><span class="p">,</span> <span class="n">genesis_validators_root</span><span class="p">:</span> <span class="n">Root</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Root</span><span class="p">:</span>
    <span class="s">"""
    Return the 32-byte fork data root for the ``current_version`` and ``genesis_validators_root``.
    This is used primarily in signature domains to avoid collisions across forks/chains.
    """</span>
    <span class="k">return</span> <span class="n">hash_tree_root</span><span class="p">(</span><span class="n">ForkData</span><span class="p">(</span>
        <span class="n">current_version</span><span class="o">=</span><span class="n">current_version</span><span class="p">,</span>
        <span class="n">genesis_validators_root</span><span class="o">=</span><span class="n">genesis_validators_root</span><span class="p">,</span>
    <span class="p">))</span>
</code></pre></div></div>

<h4 id="compute_fork_digest"><code class="language-plaintext highlighter-rouge">compute_fork_digest</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">compute_fork_digest</span><span class="p">(</span><span class="n">current_version</span><span class="p">:</span> <span class="n">Version</span><span class="p">,</span> <span class="n">genesis_validators_root</span><span class="p">:</span> <span class="n">Root</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ForkDigest</span><span class="p">:</span>
    <span class="s">"""
    Return the 4-byte fork digest for the ``current_version`` and ``genesis_validators_root``.
    This is a digest primarily used for domain separation on the p2p layer.
    4-bytes suffices for practical separation of forks/chains.
    """</span>
    <span class="k">return</span> <span class="n">ForkDigest</span><span class="p">(</span><span class="n">compute_fork_data_root</span><span class="p">(</span><span class="n">current_version</span><span class="p">,</span> <span class="n">genesis_validators_root</span><span class="p">)[:</span><span class="mi">4</span><span class="p">])</span>
</code></pre></div></div>

<h4 id="compute_domain"><code class="language-plaintext highlighter-rouge">compute_domain</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">compute_domain</span><span class="p">(</span><span class="n">domain_type</span><span class="p">:</span> <span class="n">DomainType</span><span class="p">,</span> <span class="n">fork_version</span><span class="p">:</span> <span class="n">Version</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">genesis_validators_root</span><span class="p">:</span> <span class="n">Root</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Domain</span><span class="p">:</span>
    <span class="s">"""
    Return the domain for the ``domain_type`` and ``fork_version``.
    """</span>
    <span class="k">if</span> <span class="n">fork_version</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fork_version</span> <span class="o">=</span> <span class="n">GENESIS_FORK_VERSION</span>
    <span class="k">if</span> <span class="n">genesis_validators_root</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">genesis_validators_root</span> <span class="o">=</span> <span class="n">Root</span><span class="p">()</span>  <span class="c1"># all bytes zero by default
</span>    <span class="n">fork_data_root</span> <span class="o">=</span> <span class="n">compute_fork_data_root</span><span class="p">(</span><span class="n">fork_version</span><span class="p">,</span> <span class="n">genesis_validators_root</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Domain</span><span class="p">(</span><span class="n">domain_type</span> <span class="o">+</span> <span class="n">fork_data_root</span><span class="p">[:</span><span class="mi">28</span><span class="p">])</span>
</code></pre></div></div>

<h4 id="compute_signing_root"><code class="language-plaintext highlighter-rouge">compute_signing_root</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">compute_signing_root</span><span class="p">(</span><span class="n">ssz_object</span><span class="p">:</span> <span class="n">SSZObject</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Domain</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Root</span><span class="p">:</span>
    <span class="s">"""
    Return the signing root for the corresponding signing data.
    """</span>
    <span class="k">return</span> <span class="n">hash_tree_root</span><span class="p">(</span><span class="n">SigningData</span><span class="p">(</span>
        <span class="n">object_root</span><span class="o">=</span><span class="n">hash_tree_root</span><span class="p">(</span><span class="n">ssz_object</span><span class="p">),</span>
        <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
    <span class="p">))</span>
</code></pre></div></div>

<h3 id="beacon-state-accessors">Beacon state accessors</h3>

<h4 id="get_current_epoch"><code class="language-plaintext highlighter-rouge">get_current_epoch</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Epoch</span><span class="p">:</span>
    <span class="s">"""
    Return the current epoch.
    """</span>
    <span class="k">return</span> <span class="n">compute_epoch_at_slot</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">slot</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="get_previous_epoch"><code class="language-plaintext highlighter-rouge">get_previous_epoch</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_previous_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Epoch</span><span class="p">:</span>
    <span class="s">"""`
    Return the previous epoch (unless the current epoch is ``GENESIS_EPOCH``).
    """</span>
    <span class="n">current_epoch</span> <span class="o">=</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">GENESIS_EPOCH</span> <span class="k">if</span> <span class="n">current_epoch</span> <span class="o">==</span> <span class="n">GENESIS_EPOCH</span> <span class="k">else</span> <span class="n">Epoch</span><span class="p">(</span><span class="n">current_epoch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="get_block_root"><code class="language-plaintext highlighter-rouge">get_block_root</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_block_root</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Root</span><span class="p">:</span>
    <span class="s">"""
    Return the block root at the start of a recent ``epoch``.
    """</span>
    <span class="k">return</span> <span class="n">get_block_root_at_slot</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">compute_start_slot_at_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
</code></pre></div></div>

<h4 id="get_block_root_at_slot"><code class="language-plaintext highlighter-rouge">get_block_root_at_slot</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_block_root_at_slot</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="n">Slot</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Root</span><span class="p">:</span>
    <span class="s">"""
    Return the block root at a recent ``slot``.
    """</span>
    <span class="k">assert</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="n">state</span><span class="p">.</span><span class="n">slot</span> <span class="o">&lt;=</span> <span class="n">slot</span> <span class="o">+</span> <span class="n">SLOTS_PER_HISTORICAL_ROOT</span>
    <span class="k">return</span> <span class="n">state</span><span class="p">.</span><span class="n">block_roots</span><span class="p">[</span><span class="n">slot</span> <span class="o">%</span> <span class="n">SLOTS_PER_HISTORICAL_ROOT</span><span class="p">]</span>
</code></pre></div></div>

<h4 id="get_randao_mix"><code class="language-plaintext highlighter-rouge">get_randao_mix</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_randao_mix</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Bytes32</span><span class="p">:</span>
    <span class="s">"""
    Return the randao mix at a recent ``epoch``.
    """</span>
    <span class="k">return</span> <span class="n">state</span><span class="p">.</span><span class="n">randao_mixes</span><span class="p">[</span><span class="n">epoch</span> <span class="o">%</span> <span class="n">EPOCHS_PER_HISTORICAL_VECTOR</span><span class="p">]</span>
</code></pre></div></div>

<h4 id="get_active_validator_indices"><code class="language-plaintext highlighter-rouge">get_active_validator_indices</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_active_validator_indices</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ValidatorIndex</span><span class="p">]:</span>
    <span class="s">"""
    Return the sequence of active validator indices at ``epoch``.
    """</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">ValidatorIndex</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_active_validator</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)]</span>
</code></pre></div></div>

<h4 id="get_validator_churn_limit"><code class="language-plaintext highlighter-rouge">get_validator_churn_limit</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_validator_churn_limit</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">uint64</span><span class="p">:</span>
    <span class="s">"""
    Return the validator churn limit for the current epoch.
    """</span>
    <span class="n">active_validator_indices</span> <span class="o">=</span> <span class="n">get_active_validator_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">MIN_PER_EPOCH_CHURN_LIMIT</span><span class="p">,</span> <span class="n">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">active_validator_indices</span><span class="p">))</span> <span class="o">//</span> <span class="n">CHURN_LIMIT_QUOTIENT</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="get_seed"><code class="language-plaintext highlighter-rouge">get_seed</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_seed</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">,</span> <span class="n">domain_type</span><span class="p">:</span> <span class="n">DomainType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Bytes32</span><span class="p">:</span>
    <span class="s">"""
    Return the seed at ``epoch``.
    """</span>
    <span class="n">mix</span> <span class="o">=</span> <span class="n">get_randao_mix</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">Epoch</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="n">EPOCHS_PER_HISTORICAL_VECTOR</span> <span class="o">-</span> <span class="n">MIN_SEED_LOOKAHEAD</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># Avoid underflow
</span>    <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="n">domain_type</span> <span class="o">+</span> <span class="n">uint_to_bytes</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span> <span class="o">+</span> <span class="n">mix</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="get_committee_count_per_slot"><code class="language-plaintext highlighter-rouge">get_committee_count_per_slot</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_committee_count_per_slot</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">uint64</span><span class="p">:</span>
    <span class="s">"""
    Return the number of committees in each slot for the given ``epoch``.
    """</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">uint64</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span>
        <span class="n">MAX_COMMITTEES_PER_SLOT</span><span class="p">,</span>
        <span class="n">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">get_active_validator_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)))</span> <span class="o">//</span> <span class="n">SLOTS_PER_EPOCH</span> <span class="o">//</span> <span class="n">TARGET_COMMITTEE_SIZE</span><span class="p">,</span>
    <span class="p">))</span>
</code></pre></div></div>

<h4 id="get_beacon_committee"><code class="language-plaintext highlighter-rouge">get_beacon_committee</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_beacon_committee</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="n">Slot</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">CommitteeIndex</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ValidatorIndex</span><span class="p">]:</span>
    <span class="s">"""
    Return the beacon committee at ``slot`` for ``index``.
    """</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="n">compute_epoch_at_slot</span><span class="p">(</span><span class="n">slot</span><span class="p">)</span>
    <span class="n">committees_per_slot</span> <span class="o">=</span> <span class="n">get_committee_count_per_slot</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">compute_committee</span><span class="p">(</span>
        <span class="n">indices</span><span class="o">=</span><span class="n">get_active_validator_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">epoch</span><span class="p">),</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">get_seed</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">DOMAIN_BEACON_ATTESTER</span><span class="p">),</span>
        <span class="n">index</span><span class="o">=</span><span class="p">(</span><span class="n">slot</span> <span class="o">%</span> <span class="n">SLOTS_PER_EPOCH</span><span class="p">)</span> <span class="o">*</span> <span class="n">committees_per_slot</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span>
        <span class="n">count</span><span class="o">=</span><span class="n">committees_per_slot</span> <span class="o">*</span> <span class="n">SLOTS_PER_EPOCH</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></div>

<h4 id="get_beacon_proposer_index"><code class="language-plaintext highlighter-rouge">get_beacon_proposer_index</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_beacon_proposer_index</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ValidatorIndex</span><span class="p">:</span>
    <span class="s">"""
    Return the beacon proposer index at the current slot.
    """</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">get_seed</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">DOMAIN_BEACON_PROPOSER</span><span class="p">)</span> <span class="o">+</span> <span class="n">uint_to_bytes</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">slot</span><span class="p">))</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">get_active_validator_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">compute_proposer_index</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="get_total_balance"><code class="language-plaintext highlighter-rouge">get_total_balance</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_total_balance</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">ValidatorIndex</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Gwei</span><span class="p">:</span>
    <span class="s">"""
    Return the combined effective balance of the ``indices``.
    ``EFFECTIVE_BALANCE_INCREMENT`` Gwei minimum to avoid divisions by zero.
    Math safe up to ~10B ETH, afterwhich this overflows uint64.
    """</span>
    <span class="k">return</span> <span class="n">Gwei</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">EFFECTIVE_BALANCE_INCREMENT</span><span class="p">,</span> <span class="nb">sum</span><span class="p">([</span><span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">effective_balance</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">])))</span>
</code></pre></div></div>

<h4 id="get_total_active_balance"><code class="language-plaintext highlighter-rouge">get_total_active_balance</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_total_active_balance</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Gwei</span><span class="p">:</span>
    <span class="s">"""
    Return the combined effective balance of the active validators.
    Note: ``get_total_balance`` returns ``EFFECTIVE_BALANCE_INCREMENT`` Gwei minimum to avoid divisions by zero.
    """</span>
    <span class="k">return</span> <span class="n">get_total_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_active_validator_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))))</span>
</code></pre></div></div>

<h4 id="get_domain"><code class="language-plaintext highlighter-rouge">get_domain</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_domain</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">domain_type</span><span class="p">:</span> <span class="n">DomainType</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Domain</span><span class="p">:</span>
    <span class="s">"""
    Return the signature domain (fork version concatenated with domain type) of a message.
    """</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="k">if</span> <span class="n">epoch</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">epoch</span>
    <span class="n">fork_version</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">fork</span><span class="p">.</span><span class="n">previous_version</span> <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="n">state</span><span class="p">.</span><span class="n">fork</span><span class="p">.</span><span class="n">epoch</span> <span class="k">else</span> <span class="n">state</span><span class="p">.</span><span class="n">fork</span><span class="p">.</span><span class="n">current_version</span>
    <span class="k">return</span> <span class="n">compute_domain</span><span class="p">(</span><span class="n">domain_type</span><span class="p">,</span> <span class="n">fork_version</span><span class="p">,</span> <span class="n">state</span><span class="p">.</span><span class="n">genesis_validators_root</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="get_indexed_attestation"><code class="language-plaintext highlighter-rouge">get_indexed_attestation</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_indexed_attestation</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">attestation</span><span class="p">:</span> <span class="n">Attestation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IndexedAttestation</span><span class="p">:</span>
    <span class="s">"""
    Return the indexed attestation corresponding to ``attestation``.
    """</span>
    <span class="n">attesting_indices</span> <span class="o">=</span> <span class="n">get_attesting_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attestation</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">attestation</span><span class="p">.</span><span class="n">aggregation_bits</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">IndexedAttestation</span><span class="p">(</span>
        <span class="n">attesting_indices</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">attesting_indices</span><span class="p">),</span>
        <span class="n">data</span><span class="o">=</span><span class="n">attestation</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
        <span class="n">signature</span><span class="o">=</span><span class="n">attestation</span><span class="p">.</span><span class="n">signature</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></div>

<h4 id="get_attesting_indices"><code class="language-plaintext highlighter-rouge">get_attesting_indices</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_attesting_indices</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span>
                          <span class="n">data</span><span class="p">:</span> <span class="n">AttestationData</span><span class="p">,</span>
                          <span class="n">bits</span><span class="p">:</span> <span class="n">Bitlist</span><span class="p">[</span><span class="n">MAX_VALIDATORS_PER_COMMITTEE</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">ValidatorIndex</span><span class="p">]:</span>
    <span class="s">"""
    Return the set of attesting indices corresponding to ``data`` and ``bits``.
    """</span>
    <span class="n">committee</span> <span class="o">=</span> <span class="n">get_beacon_committee</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">index</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">committee</span><span class="p">)</span> <span class="k">if</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</code></pre></div></div>

<h3 id="beacon-state-mutators">Beacon state mutators</h3>

<h4 id="increase_balance"><code class="language-plaintext highlighter-rouge">increase_balance</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">increase_balance</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">ValidatorIndex</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="n">Gwei</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="s">"""
    Increase the validator balance at index ``index`` by ``delta``.
    """</span>
    <span class="n">state</span><span class="p">.</span><span class="n">balances</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta</span>
</code></pre></div></div>

<h4 id="decrease_balance"><code class="language-plaintext highlighter-rouge">decrease_balance</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">decrease_balance</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">ValidatorIndex</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="n">Gwei</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="s">"""
    Decrease the validator balance at index ``index`` by ``delta``, with underflow protection.
    """</span>
    <span class="n">state</span><span class="p">.</span><span class="n">balances</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="n">state</span><span class="p">.</span><span class="n">balances</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">else</span> <span class="n">state</span><span class="p">.</span><span class="n">balances</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">-</span> <span class="n">delta</span>
</code></pre></div></div>

<h4 id="initiate_validator_exit"><code class="language-plaintext highlighter-rouge">initiate_validator_exit</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">initiate_validator_exit</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">ValidatorIndex</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="s">"""
    Initiate the exit of the validator with index ``index``.
    """</span>
    <span class="c1"># Return if validator already initiated exit
</span>    <span class="n">validator</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">validator</span><span class="p">.</span><span class="n">exit_epoch</span> <span class="o">!=</span> <span class="n">FAR_FUTURE_EPOCH</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Compute exit queue epoch
</span>    <span class="n">exit_epochs</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">.</span><span class="n">exit_epoch</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state</span><span class="p">.</span><span class="n">validators</span> <span class="k">if</span> <span class="n">v</span><span class="p">.</span><span class="n">exit_epoch</span> <span class="o">!=</span> <span class="n">FAR_FUTURE_EPOCH</span><span class="p">]</span>
    <span class="n">exit_queue_epoch</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">exit_epochs</span> <span class="o">+</span> <span class="p">[</span><span class="n">compute_activation_exit_epoch</span><span class="p">(</span><span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))])</span>
    <span class="n">exit_queue_churn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state</span><span class="p">.</span><span class="n">validators</span> <span class="k">if</span> <span class="n">v</span><span class="p">.</span><span class="n">exit_epoch</span> <span class="o">==</span> <span class="n">exit_queue_epoch</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">exit_queue_churn</span> <span class="o">&gt;=</span> <span class="n">get_validator_churn_limit</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
        <span class="n">exit_queue_epoch</span> <span class="o">+=</span> <span class="n">Epoch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Set validator exit epoch and withdrawable epoch
</span>    <span class="n">validator</span><span class="p">.</span><span class="n">exit_epoch</span> <span class="o">=</span> <span class="n">exit_queue_epoch</span>
    <span class="n">validator</span><span class="p">.</span><span class="n">withdrawable_epoch</span> <span class="o">=</span> <span class="n">Epoch</span><span class="p">(</span><span class="n">validator</span><span class="p">.</span><span class="n">exit_epoch</span> <span class="o">+</span> <span class="n">MIN_VALIDATOR_WITHDRAWABILITY_DELAY</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="slash_validator"><code class="language-plaintext highlighter-rouge">slash_validator</code></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">slash_validator</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span>
                    <span class="n">slashed_index</span><span class="p">:</span> <span class="n">ValidatorIndex</span><span class="p">,</span>
                    <span class="n">whistleblower_index</span><span class="p">:</span> <span class="n">ValidatorIndex</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="s">"""
    Slash the validator with index ``slashed_index``.
    """</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">initiate_validator_exit</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">slashed_index</span><span class="p">)</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">[</span><span class="n">slashed_index</span><span class="p">]</span>
    <span class="n">validator</span><span class="p">.</span><span class="n">slashed</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">validator</span><span class="p">.</span><span class="n">withdrawable_epoch</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">validator</span><span class="p">.</span><span class="n">withdrawable_epoch</span><span class="p">,</span> <span class="n">Epoch</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="n">EPOCHS_PER_SLASHINGS_VECTOR</span><span class="p">))</span>
    <span class="n">state</span><span class="p">.</span><span class="n">slashings</span><span class="p">[</span><span class="n">epoch</span> <span class="o">%</span> <span class="n">EPOCHS_PER_SLASHINGS_VECTOR</span><span class="p">]</span> <span class="o">+=</span> <span class="n">validator</span><span class="p">.</span><span class="n">effective_balance</span>
    <span class="n">decrease_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">slashed_index</span><span class="p">,</span> <span class="n">validator</span><span class="p">.</span><span class="n">effective_balance</span> <span class="o">//</span> <span class="n">MIN_SLASHING_PENALTY_QUOTIENT</span><span class="p">)</span>

    <span class="c1"># Apply proposer and whistleblower rewards
</span>    <span class="n">proposer_index</span> <span class="o">=</span> <span class="n">get_beacon_proposer_index</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">whistleblower_index</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">whistleblower_index</span> <span class="o">=</span> <span class="n">proposer_index</span>
    <span class="n">whistleblower_reward</span> <span class="o">=</span> <span class="n">Gwei</span><span class="p">(</span><span class="n">validator</span><span class="p">.</span><span class="n">effective_balance</span> <span class="o">//</span> <span class="n">WHISTLEBLOWER_REWARD_QUOTIENT</span><span class="p">)</span>
    <span class="n">proposer_reward</span> <span class="o">=</span> <span class="n">Gwei</span><span class="p">(</span><span class="n">whistleblower_reward</span> <span class="o">//</span> <span class="n">PROPOSER_REWARD_QUOTIENT</span><span class="p">)</span>
    <span class="n">increase_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">proposer_index</span><span class="p">,</span> <span class="n">proposer_reward</span><span class="p">)</span>
    <span class="n">increase_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">whistleblower_index</span><span class="p">,</span> <span class="n">Gwei</span><span class="p">(</span><span class="n">whistleblower_reward</span> <span class="o">-</span> <span class="n">proposer_reward</span><span class="p">))</span>
</code></pre></div></div>

<h2 id="genesis">Genesis</h2>

<p>Before the Ethereum 2.0 genesis has been triggered, and for every Ethereum 1.0 block, let <code class="language-plaintext highlighter-rouge">candidate_state = initialize_beacon_state_from_eth1(eth1_block_hash, eth1_timestamp, deposits)</code> where:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">eth1_block_hash</code> is the hash of the Ethereum 1.0 block</li>
  <li><code class="language-plaintext highlighter-rouge">eth1_timestamp</code> is the Unix timestamp corresponding to <code class="language-plaintext highlighter-rouge">eth1_block_hash</code></li>
  <li><code class="language-plaintext highlighter-rouge">deposits</code> is the sequence of all deposits, ordered chronologically, up to (and including) the block with hash <code class="language-plaintext highlighter-rouge">eth1_block_hash</code></li>
</ul>

<p>Eth1 blocks must only be considered once they are at least <code class="language-plaintext highlighter-rouge">SECONDS_PER_ETH1_BLOCK * ETH1_FOLLOW_DISTANCE</code> seconds old (i.e. <code class="language-plaintext highlighter-rouge">eth1_timestamp + SECONDS_PER_ETH1_BLOCK * ETH1_FOLLOW_DISTANCE &lt;= current_unix_time</code>). Due to this constraint, if <code class="language-plaintext highlighter-rouge">GENESIS_DELAY &lt; SECONDS_PER_ETH1_BLOCK * ETH1_FOLLOW_DISTANCE</code>, then the <code class="language-plaintext highlighter-rouge">genesis_time</code> can happen before the time/state is first known. Values should be configured to avoid this case.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">initialize_beacon_state_from_eth1</span><span class="p">(</span><span class="n">eth1_block_hash</span><span class="p">:</span> <span class="n">Bytes32</span><span class="p">,</span>
                                      <span class="n">eth1_timestamp</span><span class="p">:</span> <span class="n">uint64</span><span class="p">,</span>
                                      <span class="n">deposits</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Deposit</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">BeaconState</span><span class="p">:</span>
    <span class="n">fork</span> <span class="o">=</span> <span class="n">Fork</span><span class="p">(</span>
        <span class="n">previous_version</span><span class="o">=</span><span class="n">GENESIS_FORK_VERSION</span><span class="p">,</span>
        <span class="n">current_version</span><span class="o">=</span><span class="n">GENESIS_FORK_VERSION</span><span class="p">,</span>
        <span class="n">epoch</span><span class="o">=</span><span class="n">GENESIS_EPOCH</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">BeaconState</span><span class="p">(</span>
        <span class="n">genesis_time</span><span class="o">=</span><span class="n">eth1_timestamp</span> <span class="o">+</span> <span class="n">GENESIS_DELAY</span><span class="p">,</span>
        <span class="n">fork</span><span class="o">=</span><span class="n">fork</span><span class="p">,</span>
        <span class="n">eth1_data</span><span class="o">=</span><span class="n">Eth1Data</span><span class="p">(</span><span class="n">block_hash</span><span class="o">=</span><span class="n">eth1_block_hash</span><span class="p">,</span> <span class="n">deposit_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">deposits</span><span class="p">)),</span>
        <span class="n">latest_block_header</span><span class="o">=</span><span class="n">BeaconBlockHeader</span><span class="p">(</span><span class="n">body_root</span><span class="o">=</span><span class="n">hash_tree_root</span><span class="p">(</span><span class="n">BeaconBlockBody</span><span class="p">())),</span>
        <span class="n">randao_mixes</span><span class="o">=</span><span class="p">[</span><span class="n">eth1_block_hash</span><span class="p">]</span> <span class="o">*</span> <span class="n">EPOCHS_PER_HISTORICAL_VECTOR</span><span class="p">,</span>  <span class="c1"># Seed RANDAO with Eth1 entropy
</span>    <span class="p">)</span>

    <span class="c1"># Process deposits
</span>    <span class="n">leaves</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">deposit</span><span class="p">:</span> <span class="n">deposit</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">deposits</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">deposit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">deposits</span><span class="p">):</span>
        <span class="n">deposit_data_list</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="n">DepositData</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="n">DEPOSIT_CONTRACT_TREE_DEPTH</span><span class="p">](</span><span class="o">*</span><span class="n">leaves</span><span class="p">[:</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">state</span><span class="p">.</span><span class="n">eth1_data</span><span class="p">.</span><span class="n">deposit_root</span> <span class="o">=</span> <span class="n">hash_tree_root</span><span class="p">(</span><span class="n">deposit_data_list</span><span class="p">)</span>
        <span class="n">process_deposit</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">deposit</span><span class="p">)</span>

    <span class="c1"># Process activations
</span>    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">validator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">):</span>
        <span class="n">balance</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">balances</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">validator</span><span class="p">.</span><span class="n">effective_balance</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">balance</span> <span class="o">-</span> <span class="n">balance</span> <span class="o">%</span> <span class="n">EFFECTIVE_BALANCE_INCREMENT</span><span class="p">,</span> <span class="n">MAX_EFFECTIVE_BALANCE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validator</span><span class="p">.</span><span class="n">effective_balance</span> <span class="o">==</span> <span class="n">MAX_EFFECTIVE_BALANCE</span><span class="p">:</span>
            <span class="n">validator</span><span class="p">.</span><span class="n">activation_eligibility_epoch</span> <span class="o">=</span> <span class="n">GENESIS_EPOCH</span>
            <span class="n">validator</span><span class="p">.</span><span class="n">activation_epoch</span> <span class="o">=</span> <span class="n">GENESIS_EPOCH</span>

    <span class="c1"># Set genesis validators root for domain separation and chain versioning
</span>    <span class="n">state</span><span class="p">.</span><span class="n">genesis_validators_root</span> <span class="o">=</span> <span class="n">hash_tree_root</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">state</span>
</code></pre></div></div>

<p><em>Note</em>: The ETH1 block with <code class="language-plaintext highlighter-rouge">eth1_timestamp</code> meeting the minimum genesis active validator count criteria can also occur before <code class="language-plaintext highlighter-rouge">MIN_GENESIS_TIME</code>.</p>

<h3 id="genesis-state">Genesis state</h3>

<p>Let <code class="language-plaintext highlighter-rouge">genesis_state = candidate_state</code> whenever <code class="language-plaintext highlighter-rouge">is_valid_genesis_state(candidate_state) is True</code> for the first time.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">is_valid_genesis_state</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">state</span><span class="p">.</span><span class="n">genesis_time</span> <span class="o">&lt;</span> <span class="n">MIN_GENESIS_TIME</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">get_active_validator_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">GENESIS_EPOCH</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">MIN_GENESIS_ACTIVE_VALIDATOR_COUNT</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>
</code></pre></div></div>

<h3 id="genesis-block">Genesis block</h3>

<p>Let <code class="language-plaintext highlighter-rouge">genesis_block = BeaconBlock(state_root=hash_tree_root(genesis_state))</code>.</p>

<h2 id="beacon-chain-state-transition-function">Beacon chain state transition function</h2>

<p>The post-state corresponding to a pre-state <code class="language-plaintext highlighter-rouge">state</code> and a signed block <code class="language-plaintext highlighter-rouge">signed_block</code> is defined as <code class="language-plaintext highlighter-rouge">state_transition(state, signed_block)</code>. State transitions that trigger an unhandled exception (e.g. a failed <code class="language-plaintext highlighter-rouge">assert</code> or an out-of-range list access) are considered invalid. State transitions that cause a <code class="language-plaintext highlighter-rouge">uint64</code> overflow or underflow are also considered invalid.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">state_transition</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">signed_block</span><span class="p">:</span> <span class="n">SignedBeaconBlock</span><span class="p">,</span> <span class="n">validate_result</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">block</span> <span class="o">=</span> <span class="n">signed_block</span><span class="p">.</span><span class="n">message</span>
    <span class="c1"># Process slots (including those with no blocks) since block
</span>    <span class="n">process_slots</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">block</span><span class="p">.</span><span class="n">slot</span><span class="p">)</span>
    <span class="c1"># Verify signature
</span>    <span class="k">if</span> <span class="n">validate_result</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">verify_block_signature</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">signed_block</span><span class="p">)</span>
    <span class="c1"># Process block
</span>    <span class="n">process_block</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
    <span class="c1"># Verify state root
</span>    <span class="k">if</span> <span class="n">validate_result</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">block</span><span class="p">.</span><span class="n">state_root</span> <span class="o">==</span> <span class="n">hash_tree_root</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">verify_block_signature</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">signed_block</span><span class="p">:</span> <span class="n">SignedBeaconBlock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">proposer</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">[</span><span class="n">signed_block</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">proposer_index</span><span class="p">]</span>
    <span class="n">signing_root</span> <span class="o">=</span> <span class="n">compute_signing_root</span><span class="p">(</span><span class="n">signed_block</span><span class="p">.</span><span class="n">message</span><span class="p">,</span> <span class="n">get_domain</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DOMAIN_BEACON_PROPOSER</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">bls</span><span class="p">.</span><span class="n">Verify</span><span class="p">(</span><span class="n">proposer</span><span class="p">.</span><span class="n">pubkey</span><span class="p">,</span> <span class="n">signing_root</span><span class="p">,</span> <span class="n">signed_block</span><span class="p">.</span><span class="n">signature</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">process_slots</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="n">Slot</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">state</span><span class="p">.</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="n">slot</span>
    <span class="k">while</span> <span class="n">state</span><span class="p">.</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="n">slot</span><span class="p">:</span>
        <span class="n">process_slot</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="c1"># Process epoch on the start slot of the next epoch
</span>        <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">slot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">SLOTS_PER_EPOCH</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">process_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">state</span><span class="p">.</span><span class="n">slot</span> <span class="o">=</span> <span class="n">Slot</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">slot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">process_slot</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="c1"># Cache state root
</span>    <span class="n">previous_state_root</span> <span class="o">=</span> <span class="n">hash_tree_root</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">state</span><span class="p">.</span><span class="n">state_roots</span><span class="p">[</span><span class="n">state</span><span class="p">.</span><span class="n">slot</span> <span class="o">%</span> <span class="n">SLOTS_PER_HISTORICAL_ROOT</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_state_root</span>
    <span class="c1"># Cache latest block header state root
</span>    <span class="k">if</span> <span class="n">state</span><span class="p">.</span><span class="n">latest_block_header</span><span class="p">.</span><span class="n">state_root</span> <span class="o">==</span> <span class="n">Bytes32</span><span class="p">():</span>
        <span class="n">state</span><span class="p">.</span><span class="n">latest_block_header</span><span class="p">.</span><span class="n">state_root</span> <span class="o">=</span> <span class="n">previous_state_root</span>
    <span class="c1"># Cache block root
</span>    <span class="n">previous_block_root</span> <span class="o">=</span> <span class="n">hash_tree_root</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">latest_block_header</span><span class="p">)</span>
    <span class="n">state</span><span class="p">.</span><span class="n">block_roots</span><span class="p">[</span><span class="n">state</span><span class="p">.</span><span class="n">slot</span> <span class="o">%</span> <span class="n">SLOTS_PER_HISTORICAL_ROOT</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_block_root</span>
</code></pre></div></div>

<h3 id="epoch-processing">Epoch processing</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">process_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">process_justification_and_finalization</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">process_rewards_and_penalties</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">process_registry_updates</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">process_slashings</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">process_final_updates</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="helper-functions-1">Helper functions</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_matching_source_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">PendingAttestation</span><span class="p">]:</span>
    <span class="k">assert</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="p">(</span><span class="n">get_previous_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">state</span><span class="p">.</span><span class="n">current_epoch_attestations</span> <span class="k">if</span> <span class="n">epoch</span> <span class="o">==</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="k">else</span> <span class="n">state</span><span class="p">.</span><span class="n">previous_epoch_attestations</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_matching_target_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">PendingAttestation</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">get_matching_source_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">root</span> <span class="o">==</span> <span class="n">get_block_root</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
    <span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_matching_head_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="n">Epoch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">PendingAttestation</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">get_matching_target_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">beacon_block_root</span> <span class="o">==</span> <span class="n">get_block_root_at_slot</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">slot</span><span class="p">)</span>
    <span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_unslashed_attesting_indices</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span>
                                    <span class="n">attestations</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">PendingAttestation</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">ValidatorIndex</span><span class="p">]:</span>
    <span class="n">output</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># type: Set[ValidatorIndex]
</span>    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attestations</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">.</span><span class="n">union</span><span class="p">(</span><span class="n">get_attesting_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">aggregation_bits</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">index</span><span class="p">:</span> <span class="ow">not</span> <span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">slashed</span><span class="p">,</span> <span class="n">output</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_attesting_balance</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">attestations</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">PendingAttestation</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Gwei</span><span class="p">:</span>
    <span class="s">"""
    Return the combined effective balance of the set of unslashed validators participating in ``attestations``.
    Note: ``get_total_balance`` returns ``EFFECTIVE_BALANCE_INCREMENT`` Gwei minimum to avoid divisions by zero.
    """</span>
    <span class="k">return</span> <span class="n">get_total_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">get_unslashed_attesting_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attestations</span><span class="p">))</span>
</code></pre></div></div>

<h4 id="justification-and-finalization">Justification and finalization</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">process_justification_and_finalization</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="c1"># Initial FFG checkpoint values have a `0x00` stub for `root`.
</span>    <span class="c1"># Skip FFG updates in the first two epochs to avoid corner cases that might result in modifying this stub.
</span>    <span class="k">if</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">GENESIS_EPOCH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">previous_epoch</span> <span class="o">=</span> <span class="n">get_previous_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">current_epoch</span> <span class="o">=</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">old_previous_justified_checkpoint</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">previous_justified_checkpoint</span>
    <span class="n">old_current_justified_checkpoint</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">current_justified_checkpoint</span>

    <span class="c1"># Process justifications
</span>    <span class="n">state</span><span class="p">.</span><span class="n">previous_justified_checkpoint</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">current_justified_checkpoint</span>
    <span class="n">state</span><span class="p">.</span><span class="n">justification_bits</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">justification_bits</span><span class="p">[:</span><span class="n">JUSTIFICATION_BITS_LENGTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">state</span><span class="p">.</span><span class="n">justification_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mb">0b0</span>
    <span class="n">matching_target_attestations</span> <span class="o">=</span> <span class="n">get_matching_target_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">previous_epoch</span><span class="p">)</span>  <span class="c1"># Previous epoch
</span>    <span class="k">if</span> <span class="n">get_attesting_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">matching_target_attestations</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">&gt;=</span> <span class="n">get_total_active_balance</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">state</span><span class="p">.</span><span class="n">current_justified_checkpoint</span> <span class="o">=</span> <span class="n">Checkpoint</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="n">previous_epoch</span><span class="p">,</span>
                                                        <span class="n">root</span><span class="o">=</span><span class="n">get_block_root</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">previous_epoch</span><span class="p">))</span>
        <span class="n">state</span><span class="p">.</span><span class="n">justification_bits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mb">0b1</span>
    <span class="n">matching_target_attestations</span> <span class="o">=</span> <span class="n">get_matching_target_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">current_epoch</span><span class="p">)</span>  <span class="c1"># Current epoch
</span>    <span class="k">if</span> <span class="n">get_attesting_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">matching_target_attestations</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">&gt;=</span> <span class="n">get_total_active_balance</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">state</span><span class="p">.</span><span class="n">current_justified_checkpoint</span> <span class="o">=</span> <span class="n">Checkpoint</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="n">current_epoch</span><span class="p">,</span>
                                                        <span class="n">root</span><span class="o">=</span><span class="n">get_block_root</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">current_epoch</span><span class="p">))</span>
        <span class="n">state</span><span class="p">.</span><span class="n">justification_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mb">0b1</span>

    <span class="c1"># Process finalizations
</span>    <span class="n">bits</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">justification_bits</span>
    <span class="c1"># The 2nd/3rd/4th most recent epochs are justified, the 2nd using the 4th as source
</span>    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span> <span class="ow">and</span> <span class="n">old_previous_justified_checkpoint</span><span class="p">.</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">==</span> <span class="n">current_epoch</span><span class="p">:</span>
        <span class="n">state</span><span class="p">.</span><span class="n">finalized_checkpoint</span> <span class="o">=</span> <span class="n">old_previous_justified_checkpoint</span>
    <span class="c1"># The 2nd/3rd most recent epochs are justified, the 2nd using the 3rd as source
</span>    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="ow">and</span> <span class="n">old_previous_justified_checkpoint</span><span class="p">.</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">current_epoch</span><span class="p">:</span>
        <span class="n">state</span><span class="p">.</span><span class="n">finalized_checkpoint</span> <span class="o">=</span> <span class="n">old_previous_justified_checkpoint</span>
    <span class="c1"># The 1st/2nd/3rd most recent epochs are justified, the 1st using the 3rd as source
</span>    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="ow">and</span> <span class="n">old_current_justified_checkpoint</span><span class="p">.</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">current_epoch</span><span class="p">:</span>
        <span class="n">state</span><span class="p">.</span><span class="n">finalized_checkpoint</span> <span class="o">=</span> <span class="n">old_current_justified_checkpoint</span>
    <span class="c1"># The 1st/2nd most recent epochs are justified, the 1st using the 2nd as source
</span>    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="ow">and</span> <span class="n">old_current_justified_checkpoint</span><span class="p">.</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">current_epoch</span><span class="p">:</span>
        <span class="n">state</span><span class="p">.</span><span class="n">finalized_checkpoint</span> <span class="o">=</span> <span class="n">old_current_justified_checkpoint</span>
</code></pre></div></div>

<h4 id="rewards-and-penalties-1">Rewards and penalties</h4>

<h5 id="helpers">Helpers</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_base_reward</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">ValidatorIndex</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Gwei</span><span class="p">:</span>
    <span class="n">total_balance</span> <span class="o">=</span> <span class="n">get_total_active_balance</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">effective_balance</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">effective_balance</span>
    <span class="k">return</span> <span class="n">Gwei</span><span class="p">(</span><span class="n">effective_balance</span> <span class="o">*</span> <span class="n">BASE_REWARD_FACTOR</span> <span class="o">//</span> <span class="n">integer_squareroot</span><span class="p">(</span><span class="n">total_balance</span><span class="p">)</span> <span class="o">//</span> <span class="n">BASE_REWARDS_PER_EPOCH</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_proposer_reward</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">attesting_index</span><span class="p">:</span> <span class="n">ValidatorIndex</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Gwei</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Gwei</span><span class="p">(</span><span class="n">get_base_reward</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attesting_index</span><span class="p">)</span> <span class="o">//</span> <span class="n">PROPOSER_REWARD_QUOTIENT</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_finality_delay</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">uint64</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">get_previous_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">-</span> <span class="n">state</span><span class="p">.</span><span class="n">finalized_checkpoint</span><span class="p">.</span><span class="n">epoch</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">is_in_inactivity_leak</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">get_finality_delay</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MIN_EPOCHS_TO_INACTIVITY_PENALTY</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_eligible_validator_indices</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ValidatorIndex</span><span class="p">]:</span>
    <span class="n">previous_epoch</span> <span class="o">=</span> <span class="n">get_previous_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">ValidatorIndex</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_active_validator</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">previous_epoch</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">slashed</span> <span class="ow">and</span> <span class="n">previous_epoch</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">v</span><span class="p">.</span><span class="n">withdrawable_epoch</span><span class="p">)</span>
    <span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_attestation_component_deltas</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span>
                                     <span class="n">attestations</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">PendingAttestation</span><span class="p">]</span>
                                     <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Gwei</span><span class="p">],</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Gwei</span><span class="p">]]:</span>
    <span class="s">"""
    Helper with shared logic for use by get source, target, and head deltas functions
    """</span>
    <span class="n">rewards</span> <span class="o">=</span> <span class="p">[</span><span class="n">Gwei</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">)</span>
    <span class="n">penalties</span> <span class="o">=</span> <span class="p">[</span><span class="n">Gwei</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">)</span>
    <span class="n">total_balance</span> <span class="o">=</span> <span class="n">get_total_active_balance</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">unslashed_attesting_indices</span> <span class="o">=</span> <span class="n">get_unslashed_attesting_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attestations</span><span class="p">)</span>
    <span class="n">attesting_balance</span> <span class="o">=</span> <span class="n">get_total_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">unslashed_attesting_indices</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">get_eligible_validator_indices</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">unslashed_attesting_indices</span><span class="p">:</span>
            <span class="n">increment</span> <span class="o">=</span> <span class="n">EFFECTIVE_BALANCE_INCREMENT</span>  <span class="c1"># Factored out from balance totals to avoid uint64 overflow
</span>            <span class="k">if</span> <span class="n">is_in_inactivity_leak</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
                <span class="c1"># Since full base reward will be canceled out by inactivity penalty deltas,
</span>                <span class="c1"># optimal participation receives full base reward compensation here.
</span>                <span class="n">rewards</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">get_base_reward</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reward_numerator</span> <span class="o">=</span> <span class="n">get_base_reward</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">attesting_balance</span> <span class="o">//</span> <span class="n">increment</span><span class="p">)</span>
                <span class="n">rewards</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">reward_numerator</span> <span class="o">//</span> <span class="p">(</span><span class="n">total_balance</span> <span class="o">//</span> <span class="n">increment</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">penalties</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">get_base_reward</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">penalties</span>
</code></pre></div></div>

<h5 id="components-of-attestation-deltas">Components of attestation deltas</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_source_deltas</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Gwei</span><span class="p">],</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Gwei</span><span class="p">]]:</span>
    <span class="s">"""
    Return attester micro-rewards/penalties for source-vote for each validator.
    """</span>
    <span class="n">matching_source_attestations</span> <span class="o">=</span> <span class="n">get_matching_source_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">get_previous_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">get_attestation_component_deltas</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">matching_source_attestations</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_target_deltas</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Gwei</span><span class="p">],</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Gwei</span><span class="p">]]:</span>
    <span class="s">"""
    Return attester micro-rewards/penalties for target-vote for each validator.
    """</span>
    <span class="n">matching_target_attestations</span> <span class="o">=</span> <span class="n">get_matching_target_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">get_previous_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">get_attestation_component_deltas</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">matching_target_attestations</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_head_deltas</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Gwei</span><span class="p">],</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Gwei</span><span class="p">]]:</span>
    <span class="s">"""
    Return attester micro-rewards/penalties for head-vote for each validator.
    """</span>
    <span class="n">matching_head_attestations</span> <span class="o">=</span> <span class="n">get_matching_head_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">get_previous_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">get_attestation_component_deltas</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">matching_head_attestations</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_inclusion_delay_deltas</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Gwei</span><span class="p">],</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Gwei</span><span class="p">]]:</span>
    <span class="s">"""
    Return proposer and inclusion delay micro-rewards/penalties for each validator.
    """</span>
    <span class="n">rewards</span> <span class="o">=</span> <span class="p">[</span><span class="n">Gwei</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">))]</span>
    <span class="n">matching_source_attestations</span> <span class="o">=</span> <span class="n">get_matching_source_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">get_previous_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">get_unslashed_attesting_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">matching_source_attestations</span><span class="p">):</span>
        <span class="n">attestation</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span>
            <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">matching_source_attestations</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">get_attesting_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">aggregation_bits</span><span class="p">)</span>
        <span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="p">.</span><span class="n">inclusion_delay</span><span class="p">)</span>
        <span class="n">rewards</span><span class="p">[</span><span class="n">attestation</span><span class="p">.</span><span class="n">proposer_index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">get_proposer_reward</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">max_attester_reward</span> <span class="o">=</span> <span class="n">Gwei</span><span class="p">(</span><span class="n">get_base_reward</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="o">-</span> <span class="n">get_proposer_reward</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>
        <span class="n">rewards</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Gwei</span><span class="p">(</span><span class="n">max_attester_reward</span> <span class="o">//</span> <span class="n">attestation</span><span class="p">.</span><span class="n">inclusion_delay</span><span class="p">)</span>

    <span class="c1"># No penalties associated with inclusion delay
</span>    <span class="n">penalties</span> <span class="o">=</span> <span class="p">[</span><span class="n">Gwei</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">penalties</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_inactivity_penalty_deltas</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Gwei</span><span class="p">],</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Gwei</span><span class="p">]]:</span>
    <span class="s">"""
    Return inactivity reward/penalty deltas for each validator.
    """</span>
    <span class="n">penalties</span> <span class="o">=</span> <span class="p">[</span><span class="n">Gwei</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">))]</span>
    <span class="k">if</span> <span class="n">is_in_inactivity_leak</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
        <span class="n">matching_target_attestations</span> <span class="o">=</span> <span class="n">get_matching_target_attestations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">get_previous_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
        <span class="n">matching_target_attesting_indices</span> <span class="o">=</span> <span class="n">get_unslashed_attesting_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">matching_target_attestations</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">get_eligible_validator_indices</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
            <span class="c1"># If validator is performing optimally this cancels all rewards for a neutral balance
</span>            <span class="n">base_reward</span> <span class="o">=</span> <span class="n">get_base_reward</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="n">penalties</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Gwei</span><span class="p">(</span><span class="n">BASE_REWARDS_PER_EPOCH</span> <span class="o">*</span> <span class="n">base_reward</span> <span class="o">-</span> <span class="n">get_proposer_reward</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matching_target_attesting_indices</span><span class="p">:</span>
                <span class="n">effective_balance</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">effective_balance</span>
                <span class="n">penalties</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Gwei</span><span class="p">(</span><span class="n">effective_balance</span> <span class="o">*</span> <span class="n">get_finality_delay</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">//</span> <span class="n">INACTIVITY_PENALTY_QUOTIENT</span><span class="p">)</span>

    <span class="c1"># No rewards associated with inactivity penalties
</span>    <span class="n">rewards</span> <span class="o">=</span> <span class="p">[</span><span class="n">Gwei</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">penalties</span>
</code></pre></div></div>

<h5 id="get_attestation_deltas"><code class="language-plaintext highlighter-rouge">get_attestation_deltas</code></h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_attestation_deltas</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Gwei</span><span class="p">],</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Gwei</span><span class="p">]]:</span>
    <span class="s">"""
    Return attestation reward/penalty deltas for each validator.
    """</span>
    <span class="n">source_rewards</span><span class="p">,</span> <span class="n">source_penalties</span> <span class="o">=</span> <span class="n">get_source_deltas</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">target_rewards</span><span class="p">,</span> <span class="n">target_penalties</span> <span class="o">=</span> <span class="n">get_target_deltas</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">head_rewards</span><span class="p">,</span> <span class="n">head_penalties</span> <span class="o">=</span> <span class="n">get_head_deltas</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">inclusion_delay_rewards</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_inclusion_delay_deltas</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">inactivity_penalties</span> <span class="o">=</span> <span class="n">get_inactivity_penalty_deltas</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

    <span class="n">rewards</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">source_rewards</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">target_rewards</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">head_rewards</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">inclusion_delay_rewards</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">))</span>
    <span class="p">]</span>

    <span class="n">penalties</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">source_penalties</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">target_penalties</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">head_penalties</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">inactivity_penalties</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">))</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">penalties</span>
</code></pre></div></div>

<h5 id="process_rewards_and_penalties"><code class="language-plaintext highlighter-rouge">process_rewards_and_penalties</code></h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">process_rewards_and_penalties</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="c1"># No rewards are applied at the end of `GENESIS_EPOCH` because rewards are for work done in the previous epoch
</span>    <span class="k">if</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">==</span> <span class="n">GENESIS_EPOCH</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">rewards</span><span class="p">,</span> <span class="n">penalties</span> <span class="o">=</span> <span class="n">get_attestation_deltas</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">)):</span>
        <span class="n">increase_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ValidatorIndex</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">rewards</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">decrease_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ValidatorIndex</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">penalties</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</code></pre></div></div>

<h4 id="registry-updates">Registry updates</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">process_registry_updates</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="c1"># Process activation eligibility and ejections
</span>    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">validator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_eligible_for_activation_queue</span><span class="p">(</span><span class="n">validator</span><span class="p">):</span>
            <span class="n">validator</span><span class="p">.</span><span class="n">activation_eligibility_epoch</span> <span class="o">=</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">is_active_validator</span><span class="p">(</span><span class="n">validator</span><span class="p">,</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))</span> <span class="ow">and</span> <span class="n">validator</span><span class="p">.</span><span class="n">effective_balance</span> <span class="o">&lt;=</span> <span class="n">EJECTION_BALANCE</span><span class="p">:</span>
            <span class="n">initiate_validator_exit</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ValidatorIndex</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

    <span class="c1"># Queue validators eligible for activation and not yet dequeued for activation
</span>    <span class="n">activation_queue</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span>
        <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">validator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_eligible_for_activation</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">validator</span><span class="p">)</span>
        <span class="c1"># Order by the sequence of activation_eligibility_epoch setting and then index
</span>    <span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">index</span><span class="p">:</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">activation_eligibility_epoch</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>
    <span class="c1"># Dequeued validators for activation up to churn limit
</span>    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">activation_queue</span><span class="p">[:</span><span class="n">get_validator_churn_limit</span><span class="p">(</span><span class="n">state</span><span class="p">)]:</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">validator</span><span class="p">.</span><span class="n">activation_epoch</span> <span class="o">=</span> <span class="n">compute_activation_exit_epoch</span><span class="p">(</span><span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
</code></pre></div></div>

<h4 id="slashings">Slashings</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">process_slashings</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">total_balance</span> <span class="o">=</span> <span class="n">get_total_active_balance</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">adjusted_total_slashing_balance</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">slashings</span><span class="p">)</span> <span class="o">*</span> <span class="n">PROPORTIONAL_SLASHING_MULTIPLIER</span><span class="p">,</span> <span class="n">total_balance</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">validator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">validator</span><span class="p">.</span><span class="n">slashed</span> <span class="ow">and</span> <span class="n">epoch</span> <span class="o">+</span> <span class="n">EPOCHS_PER_SLASHINGS_VECTOR</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">validator</span><span class="p">.</span><span class="n">withdrawable_epoch</span><span class="p">:</span>
            <span class="n">increment</span> <span class="o">=</span> <span class="n">EFFECTIVE_BALANCE_INCREMENT</span>  <span class="c1"># Factored out from penalty numerator to avoid uint64 overflow
</span>            <span class="n">penalty_numerator</span> <span class="o">=</span> <span class="n">validator</span><span class="p">.</span><span class="n">effective_balance</span> <span class="o">//</span> <span class="n">increment</span> <span class="o">*</span> <span class="n">adjusted_total_slashing_balance</span>
            <span class="n">penalty</span> <span class="o">=</span> <span class="n">penalty_numerator</span> <span class="o">//</span> <span class="n">total_balance</span> <span class="o">*</span> <span class="n">increment</span>
            <span class="n">decrease_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ValidatorIndex</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">penalty</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="final-updates">Final updates</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">process_final_updates</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">current_epoch</span> <span class="o">=</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">next_epoch</span> <span class="o">=</span> <span class="n">Epoch</span><span class="p">(</span><span class="n">current_epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Reset eth1 data votes
</span>    <span class="k">if</span> <span class="n">next_epoch</span> <span class="o">%</span> <span class="n">EPOCHS_PER_ETH1_VOTING_PERIOD</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">state</span><span class="p">.</span><span class="n">eth1_data_votes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Update effective balances with hysteresis
</span>    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">validator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">):</span>
        <span class="n">balance</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">balances</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">HYSTERESIS_INCREMENT</span> <span class="o">=</span> <span class="n">uint64</span><span class="p">(</span><span class="n">EFFECTIVE_BALANCE_INCREMENT</span> <span class="o">//</span> <span class="n">HYSTERESIS_QUOTIENT</span><span class="p">)</span>
        <span class="n">DOWNWARD_THRESHOLD</span> <span class="o">=</span> <span class="n">HYSTERESIS_INCREMENT</span> <span class="o">*</span> <span class="n">HYSTERESIS_DOWNWARD_MULTIPLIER</span>
        <span class="n">UPWARD_THRESHOLD</span> <span class="o">=</span> <span class="n">HYSTERESIS_INCREMENT</span> <span class="o">*</span> <span class="n">HYSTERESIS_UPWARD_MULTIPLIER</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">balance</span> <span class="o">+</span> <span class="n">DOWNWARD_THRESHOLD</span> <span class="o">&lt;</span> <span class="n">validator</span><span class="p">.</span><span class="n">effective_balance</span>
            <span class="ow">or</span> <span class="n">validator</span><span class="p">.</span><span class="n">effective_balance</span> <span class="o">+</span> <span class="n">UPWARD_THRESHOLD</span> <span class="o">&lt;</span> <span class="n">balance</span>
        <span class="p">):</span>
            <span class="n">validator</span><span class="p">.</span><span class="n">effective_balance</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">balance</span> <span class="o">-</span> <span class="n">balance</span> <span class="o">%</span> <span class="n">EFFECTIVE_BALANCE_INCREMENT</span><span class="p">,</span> <span class="n">MAX_EFFECTIVE_BALANCE</span><span class="p">)</span>
    <span class="c1"># Reset slashings
</span>    <span class="n">state</span><span class="p">.</span><span class="n">slashings</span><span class="p">[</span><span class="n">next_epoch</span> <span class="o">%</span> <span class="n">EPOCHS_PER_SLASHINGS_VECTOR</span><span class="p">]</span> <span class="o">=</span> <span class="n">Gwei</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Set randao mix
</span>    <span class="n">state</span><span class="p">.</span><span class="n">randao_mixes</span><span class="p">[</span><span class="n">next_epoch</span> <span class="o">%</span> <span class="n">EPOCHS_PER_HISTORICAL_VECTOR</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_randao_mix</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">current_epoch</span><span class="p">)</span>
    <span class="c1"># Set historical root accumulator
</span>    <span class="k">if</span> <span class="n">next_epoch</span> <span class="o">%</span> <span class="p">(</span><span class="n">SLOTS_PER_HISTORICAL_ROOT</span> <span class="o">//</span> <span class="n">SLOTS_PER_EPOCH</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">historical_batch</span> <span class="o">=</span> <span class="n">HistoricalBatch</span><span class="p">(</span><span class="n">block_roots</span><span class="o">=</span><span class="n">state</span><span class="p">.</span><span class="n">block_roots</span><span class="p">,</span> <span class="n">state_roots</span><span class="o">=</span><span class="n">state</span><span class="p">.</span><span class="n">state_roots</span><span class="p">)</span>
        <span class="n">state</span><span class="p">.</span><span class="n">historical_roots</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">hash_tree_root</span><span class="p">(</span><span class="n">historical_batch</span><span class="p">))</span>
    <span class="c1"># Rotate current/previous epoch attestations
</span>    <span class="n">state</span><span class="p">.</span><span class="n">previous_epoch_attestations</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">current_epoch_attestations</span>
    <span class="n">state</span><span class="p">.</span><span class="n">current_epoch_attestations</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></div>

<h3 id="block-processing">Block processing</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">process_block</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">BeaconBlock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">process_block_header</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
    <span class="n">process_randao</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">block</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
    <span class="n">process_eth1_data</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">block</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
    <span class="n">process_operations</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">block</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="block-header">Block header</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">process_block_header</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">BeaconBlock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="c1"># Verify that the slots match
</span>    <span class="k">assert</span> <span class="n">block</span><span class="p">.</span><span class="n">slot</span> <span class="o">==</span> <span class="n">state</span><span class="p">.</span><span class="n">slot</span>
    <span class="c1"># Verify that the block is newer than latest block header
</span>    <span class="k">assert</span> <span class="n">block</span><span class="p">.</span><span class="n">slot</span> <span class="o">&gt;</span> <span class="n">state</span><span class="p">.</span><span class="n">latest_block_header</span><span class="p">.</span><span class="n">slot</span>
    <span class="c1"># Verify that proposer index is the correct index
</span>    <span class="k">assert</span> <span class="n">block</span><span class="p">.</span><span class="n">proposer_index</span> <span class="o">==</span> <span class="n">get_beacon_proposer_index</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="c1"># Verify that the parent matches
</span>    <span class="k">assert</span> <span class="n">block</span><span class="p">.</span><span class="n">parent_root</span> <span class="o">==</span> <span class="n">hash_tree_root</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">latest_block_header</span><span class="p">)</span>
    <span class="c1"># Cache current block as the new latest block
</span>    <span class="n">state</span><span class="p">.</span><span class="n">latest_block_header</span> <span class="o">=</span> <span class="n">BeaconBlockHeader</span><span class="p">(</span>
        <span class="n">slot</span><span class="o">=</span><span class="n">block</span><span class="p">.</span><span class="n">slot</span><span class="p">,</span>
        <span class="n">proposer_index</span><span class="o">=</span><span class="n">block</span><span class="p">.</span><span class="n">proposer_index</span><span class="p">,</span>
        <span class="n">parent_root</span><span class="o">=</span><span class="n">block</span><span class="p">.</span><span class="n">parent_root</span><span class="p">,</span>
        <span class="n">state_root</span><span class="o">=</span><span class="n">Bytes32</span><span class="p">(),</span>  <span class="c1"># Overwritten in the next process_slot call
</span>        <span class="n">body_root</span><span class="o">=</span><span class="n">hash_tree_root</span><span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="n">body</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Verify proposer is not slashed
</span>    <span class="n">proposer</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">[</span><span class="n">block</span><span class="p">.</span><span class="n">proposer_index</span><span class="p">]</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">proposer</span><span class="p">.</span><span class="n">slashed</span>
</code></pre></div></div>

<h4 id="randao">RANDAO</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">process_randao</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">BeaconBlockBody</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="c1"># Verify RANDAO reveal
</span>    <span class="n">proposer</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">[</span><span class="n">get_beacon_proposer_index</span><span class="p">(</span><span class="n">state</span><span class="p">)]</span>
    <span class="n">signing_root</span> <span class="o">=</span> <span class="n">compute_signing_root</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">get_domain</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DOMAIN_RANDAO</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">bls</span><span class="p">.</span><span class="n">Verify</span><span class="p">(</span><span class="n">proposer</span><span class="p">.</span><span class="n">pubkey</span><span class="p">,</span> <span class="n">signing_root</span><span class="p">,</span> <span class="n">body</span><span class="p">.</span><span class="n">randao_reveal</span><span class="p">)</span>
    <span class="c1"># Mix in RANDAO reveal
</span>    <span class="n">mix</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">get_randao_mix</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">epoch</span><span class="p">),</span> <span class="nb">hash</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="n">randao_reveal</span><span class="p">))</span>
    <span class="n">state</span><span class="p">.</span><span class="n">randao_mixes</span><span class="p">[</span><span class="n">epoch</span> <span class="o">%</span> <span class="n">EPOCHS_PER_HISTORICAL_VECTOR</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span>
</code></pre></div></div>

<h4 id="eth1-data">Eth1 data</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">process_eth1_data</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">BeaconBlockBody</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">state</span><span class="p">.</span><span class="n">eth1_data_votes</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="n">eth1_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">state</span><span class="p">.</span><span class="n">eth1_data_votes</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="n">eth1_data</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">EPOCHS_PER_ETH1_VOTING_PERIOD</span> <span class="o">*</span> <span class="n">SLOTS_PER_EPOCH</span><span class="p">:</span>
        <span class="n">state</span><span class="p">.</span><span class="n">eth1_data</span> <span class="o">=</span> <span class="n">body</span><span class="p">.</span><span class="n">eth1_data</span>
</code></pre></div></div>

<h4 id="operations">Operations</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">process_operations</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">BeaconBlockBody</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="c1"># Verify that outstanding deposits are processed up to the maximum number of deposits
</span>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="n">deposits</span><span class="p">)</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">MAX_DEPOSITS</span><span class="p">,</span> <span class="n">state</span><span class="p">.</span><span class="n">eth1_data</span><span class="p">.</span><span class="n">deposit_count</span> <span class="o">-</span> <span class="n">state</span><span class="p">.</span><span class="n">eth1_deposit_index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">for_ops</span><span class="p">(</span><span class="n">operations</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">BeaconState</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="bp">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">operation</span> <span class="ow">in</span> <span class="n">operations</span><span class="p">:</span>
            <span class="n">fn</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>

    <span class="n">for_ops</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="n">proposer_slashings</span><span class="p">,</span> <span class="n">process_proposer_slashing</span><span class="p">)</span>
    <span class="n">for_ops</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="n">attester_slashings</span><span class="p">,</span> <span class="n">process_attester_slashing</span><span class="p">)</span>
    <span class="n">for_ops</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="n">attestations</span><span class="p">,</span> <span class="n">process_attestation</span><span class="p">)</span>
    <span class="n">for_ops</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="n">deposits</span><span class="p">,</span> <span class="n">process_deposit</span><span class="p">)</span>
    <span class="n">for_ops</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="n">voluntary_exits</span><span class="p">,</span> <span class="n">process_voluntary_exit</span><span class="p">)</span>
</code></pre></div></div>

<h5 id="proposer-slashings">Proposer slashings</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">process_proposer_slashing</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">proposer_slashing</span><span class="p">:</span> <span class="n">ProposerSlashing</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">header_1</span> <span class="o">=</span> <span class="n">proposer_slashing</span><span class="p">.</span><span class="n">signed_header_1</span><span class="p">.</span><span class="n">message</span>
    <span class="n">header_2</span> <span class="o">=</span> <span class="n">proposer_slashing</span><span class="p">.</span><span class="n">signed_header_2</span><span class="p">.</span><span class="n">message</span>

    <span class="c1"># Verify header slots match
</span>    <span class="k">assert</span> <span class="n">header_1</span><span class="p">.</span><span class="n">slot</span> <span class="o">==</span> <span class="n">header_2</span><span class="p">.</span><span class="n">slot</span>
    <span class="c1"># Verify header proposer indices match
</span>    <span class="k">assert</span> <span class="n">header_1</span><span class="p">.</span><span class="n">proposer_index</span> <span class="o">==</span> <span class="n">header_2</span><span class="p">.</span><span class="n">proposer_index</span>
    <span class="c1"># Verify the headers are different
</span>    <span class="k">assert</span> <span class="n">header_1</span> <span class="o">!=</span> <span class="n">header_2</span>
    <span class="c1"># Verify the proposer is slashable
</span>    <span class="n">proposer</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">[</span><span class="n">header_1</span><span class="p">.</span><span class="n">proposer_index</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">is_slashable_validator</span><span class="p">(</span><span class="n">proposer</span><span class="p">,</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
    <span class="c1"># Verify signatures
</span>    <span class="k">for</span> <span class="n">signed_header</span> <span class="ow">in</span> <span class="p">(</span><span class="n">proposer_slashing</span><span class="p">.</span><span class="n">signed_header_1</span><span class="p">,</span> <span class="n">proposer_slashing</span><span class="p">.</span><span class="n">signed_header_2</span><span class="p">):</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">get_domain</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DOMAIN_BEACON_PROPOSER</span><span class="p">,</span> <span class="n">compute_epoch_at_slot</span><span class="p">(</span><span class="n">signed_header</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">slot</span><span class="p">))</span>
        <span class="n">signing_root</span> <span class="o">=</span> <span class="n">compute_signing_root</span><span class="p">(</span><span class="n">signed_header</span><span class="p">.</span><span class="n">message</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">bls</span><span class="p">.</span><span class="n">Verify</span><span class="p">(</span><span class="n">proposer</span><span class="p">.</span><span class="n">pubkey</span><span class="p">,</span> <span class="n">signing_root</span><span class="p">,</span> <span class="n">signed_header</span><span class="p">.</span><span class="n">signature</span><span class="p">)</span>

    <span class="n">slash_validator</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">header_1</span><span class="p">.</span><span class="n">proposer_index</span><span class="p">)</span>
</code></pre></div></div>

<h5 id="attester-slashings">Attester slashings</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">process_attester_slashing</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">attester_slashing</span><span class="p">:</span> <span class="n">AttesterSlashing</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">attestation_1</span> <span class="o">=</span> <span class="n">attester_slashing</span><span class="p">.</span><span class="n">attestation_1</span>
    <span class="n">attestation_2</span> <span class="o">=</span> <span class="n">attester_slashing</span><span class="p">.</span><span class="n">attestation_2</span>
    <span class="k">assert</span> <span class="n">is_slashable_attestation_data</span><span class="p">(</span><span class="n">attestation_1</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">attestation_2</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">is_valid_indexed_attestation</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attestation_1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">is_valid_indexed_attestation</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attestation_2</span><span class="p">)</span>

    <span class="n">slashed_any</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">attestation_1</span><span class="p">.</span><span class="n">attesting_indices</span><span class="p">).</span><span class="n">intersection</span><span class="p">(</span><span class="n">attestation_2</span><span class="p">.</span><span class="n">attesting_indices</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_slashable_validator</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)):</span>
            <span class="n">slash_validator</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="n">slashed_any</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">assert</span> <span class="n">slashed_any</span>
</code></pre></div></div>

<h5 id="attestations">Attestations</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">process_attestation</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">attestation</span><span class="p">:</span> <span class="n">Attestation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">attestation</span><span class="p">.</span><span class="n">data</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">epoch</span> <span class="ow">in</span> <span class="p">(</span><span class="n">get_previous_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">epoch</span> <span class="o">==</span> <span class="n">compute_epoch_at_slot</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">slot</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">.</span><span class="n">slot</span> <span class="o">+</span> <span class="n">MIN_ATTESTATION_INCLUSION_DELAY</span> <span class="o">&lt;=</span> <span class="n">state</span><span class="p">.</span><span class="n">slot</span> <span class="o">&lt;=</span> <span class="n">data</span><span class="p">.</span><span class="n">slot</span> <span class="o">+</span> <span class="n">SLOTS_PER_EPOCH</span>
    <span class="k">assert</span> <span class="n">data</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">get_committee_count_per_slot</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">epoch</span><span class="p">)</span>

    <span class="n">committee</span> <span class="o">=</span> <span class="n">get_beacon_committee</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attestation</span><span class="p">.</span><span class="n">aggregation_bits</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">committee</span><span class="p">)</span>

    <span class="n">pending_attestation</span> <span class="o">=</span> <span class="n">PendingAttestation</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
        <span class="n">aggregation_bits</span><span class="o">=</span><span class="n">attestation</span><span class="p">.</span><span class="n">aggregation_bits</span><span class="p">,</span>
        <span class="n">inclusion_delay</span><span class="o">=</span><span class="n">state</span><span class="p">.</span><span class="n">slot</span> <span class="o">-</span> <span class="n">data</span><span class="p">.</span><span class="n">slot</span><span class="p">,</span>
        <span class="n">proposer_index</span><span class="o">=</span><span class="n">get_beacon_proposer_index</span><span class="p">(</span><span class="n">state</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">epoch</span> <span class="o">==</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">data</span><span class="p">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">state</span><span class="p">.</span><span class="n">current_justified_checkpoint</span>
        <span class="n">state</span><span class="p">.</span><span class="n">current_epoch_attestations</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">pending_attestation</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">data</span><span class="p">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">state</span><span class="p">.</span><span class="n">previous_justified_checkpoint</span>
        <span class="n">state</span><span class="p">.</span><span class="n">previous_epoch_attestations</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">pending_attestation</span><span class="p">)</span>

    <span class="c1"># Verify signature
</span>    <span class="k">assert</span> <span class="n">is_valid_indexed_attestation</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">get_indexed_attestation</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attestation</span><span class="p">))</span>
</code></pre></div></div>

<h5 id="deposits">Deposits</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_validator_from_deposit</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">deposit</span><span class="p">:</span> <span class="n">Deposit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Validator</span><span class="p">:</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="n">deposit</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">amount</span>
    <span class="n">effective_balance</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">amount</span> <span class="o">-</span> <span class="n">amount</span> <span class="o">%</span> <span class="n">EFFECTIVE_BALANCE_INCREMENT</span><span class="p">,</span> <span class="n">MAX_EFFECTIVE_BALANCE</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Validator</span><span class="p">(</span>
        <span class="n">pubkey</span><span class="o">=</span><span class="n">deposit</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pubkey</span><span class="p">,</span>
        <span class="n">withdrawal_credentials</span><span class="o">=</span><span class="n">deposit</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">withdrawal_credentials</span><span class="p">,</span>
        <span class="n">activation_eligibility_epoch</span><span class="o">=</span><span class="n">FAR_FUTURE_EPOCH</span><span class="p">,</span>
        <span class="n">activation_epoch</span><span class="o">=</span><span class="n">FAR_FUTURE_EPOCH</span><span class="p">,</span>
        <span class="n">exit_epoch</span><span class="o">=</span><span class="n">FAR_FUTURE_EPOCH</span><span class="p">,</span>
        <span class="n">withdrawable_epoch</span><span class="o">=</span><span class="n">FAR_FUTURE_EPOCH</span><span class="p">,</span>
        <span class="n">effective_balance</span><span class="o">=</span><span class="n">effective_balance</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">process_deposit</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">deposit</span><span class="p">:</span> <span class="n">Deposit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="c1"># Verify the Merkle branch
</span>    <span class="k">assert</span> <span class="n">is_valid_merkle_branch</span><span class="p">(</span>
        <span class="n">leaf</span><span class="o">=</span><span class="n">hash_tree_root</span><span class="p">(</span><span class="n">deposit</span><span class="p">.</span><span class="n">data</span><span class="p">),</span>
        <span class="n">branch</span><span class="o">=</span><span class="n">deposit</span><span class="p">.</span><span class="n">proof</span><span class="p">,</span>
        <span class="n">depth</span><span class="o">=</span><span class="n">DEPOSIT_CONTRACT_TREE_DEPTH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># Add 1 for the List length mix-in
</span>        <span class="n">index</span><span class="o">=</span><span class="n">state</span><span class="p">.</span><span class="n">eth1_deposit_index</span><span class="p">,</span>
        <span class="n">root</span><span class="o">=</span><span class="n">state</span><span class="p">.</span><span class="n">eth1_data</span><span class="p">.</span><span class="n">deposit_root</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Deposits must be processed in order
</span>    <span class="n">state</span><span class="p">.</span><span class="n">eth1_deposit_index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">pubkey</span> <span class="o">=</span> <span class="n">deposit</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pubkey</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="n">deposit</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">amount</span>
    <span class="n">validator_pubkeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">.</span><span class="n">pubkey</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">pubkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">validator_pubkeys</span><span class="p">:</span>
        <span class="c1"># Verify the deposit signature (proof of possession) which is not checked by the deposit contract
</span>        <span class="n">deposit_message</span> <span class="o">=</span> <span class="n">DepositMessage</span><span class="p">(</span>
            <span class="n">pubkey</span><span class="o">=</span><span class="n">deposit</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pubkey</span><span class="p">,</span>
            <span class="n">withdrawal_credentials</span><span class="o">=</span><span class="n">deposit</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">withdrawal_credentials</span><span class="p">,</span>
            <span class="n">amount</span><span class="o">=</span><span class="n">deposit</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">amount</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">compute_domain</span><span class="p">(</span><span class="n">DOMAIN_DEPOSIT</span><span class="p">)</span>  <span class="c1"># Fork-agnostic domain since deposits are valid across forks
</span>        <span class="n">signing_root</span> <span class="o">=</span> <span class="n">compute_signing_root</span><span class="p">(</span><span class="n">deposit_message</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bls</span><span class="p">.</span><span class="n">Verify</span><span class="p">(</span><span class="n">pubkey</span><span class="p">,</span> <span class="n">signing_root</span><span class="p">,</span> <span class="n">deposit</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">signature</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># Add validator and balance entries
</span>        <span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_validator_from_deposit</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">deposit</span><span class="p">))</span>
        <span class="n">state</span><span class="p">.</span><span class="n">balances</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Increase balance by deposit amount
</span>        <span class="n">index</span> <span class="o">=</span> <span class="n">ValidatorIndex</span><span class="p">(</span><span class="n">validator_pubkeys</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="n">pubkey</span><span class="p">))</span>
        <span class="n">increase_balance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
</code></pre></div></div>

<h5 id="voluntary-exits">Voluntary exits</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">process_voluntary_exit</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">BeaconState</span><span class="p">,</span> <span class="n">signed_voluntary_exit</span><span class="p">:</span> <span class="n">SignedVoluntaryExit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">voluntary_exit</span> <span class="o">=</span> <span class="n">signed_voluntary_exit</span><span class="p">.</span><span class="n">message</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">[</span><span class="n">voluntary_exit</span><span class="p">.</span><span class="n">validator_index</span><span class="p">]</span>
    <span class="c1"># Verify the validator is active
</span>    <span class="k">assert</span> <span class="n">is_active_validator</span><span class="p">(</span><span class="n">validator</span><span class="p">,</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
    <span class="c1"># Verify exit has not been initiated
</span>    <span class="k">assert</span> <span class="n">validator</span><span class="p">.</span><span class="n">exit_epoch</span> <span class="o">==</span> <span class="n">FAR_FUTURE_EPOCH</span>
    <span class="c1"># Exits must specify an epoch when they become valid; they are not valid before then
</span>    <span class="k">assert</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">voluntary_exit</span><span class="p">.</span><span class="n">epoch</span>
    <span class="c1"># Verify the validator has been active long enough
</span>    <span class="k">assert</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">validator</span><span class="p">.</span><span class="n">activation_epoch</span> <span class="o">+</span> <span class="n">SHARD_COMMITTEE_PERIOD</span>
    <span class="c1"># Verify signature
</span>    <span class="n">domain</span> <span class="o">=</span> <span class="n">get_domain</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">DOMAIN_VOLUNTARY_EXIT</span><span class="p">,</span> <span class="n">voluntary_exit</span><span class="p">.</span><span class="n">epoch</span><span class="p">)</span>
    <span class="n">signing_root</span> <span class="o">=</span> <span class="n">compute_signing_root</span><span class="p">(</span><span class="n">voluntary_exit</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">bls</span><span class="p">.</span><span class="n">Verify</span><span class="p">(</span><span class="n">validator</span><span class="p">.</span><span class="n">pubkey</span><span class="p">,</span> <span class="n">signing_root</span><span class="p">,</span> <span class="n">signed_voluntary_exit</span><span class="p">.</span><span class="n">signature</span><span class="p">)</span>
    <span class="c1"># Initiate exit
</span>    <span class="n">initiate_validator_exit</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">voluntary_exit</span><span class="p">.</span><span class="n">validator_index</span><span class="p">)</span>
</code></pre></div></div>



<p>
	<strong> SSZ SimpleSerialize for Eth2 </strong>
</p>


